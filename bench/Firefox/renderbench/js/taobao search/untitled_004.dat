/*! umpp 2014-08-25 */
KISSY.add("tbc/umpp/1.4.20/mods/messenger",function(a){function b(a,b){return u.push([a,b])-1}function c(a){return u[a]=null}function d(b,c,d){var e={type:b,content:c},f=d;if(a.isString(d)?(f=m.get("#"+d),d=f.contentWindow):d.contentWindow&&(d=d.contentWindow),i())try{return d.KISSY.TBC.Messenger.fire(b,c)}catch(g){}o?j&&(j.callSWF?j.callSWF("send",[e,h(f)]):j.send(e,h(f))):d.postMessage(n.stringify(e),"*")}function e(b,c){a.each(u,function(a){a&&a[0]===b&&a[1](c)})}function f(b,c){var d,e=(o?"parentFlash="+x+"&childFlash=_MessengerChildFlash_"+a.now()+"&":"")+"domain=taobao.org";a.isString(b)?(d=b,b={}):d=b.src,b.src=d+(d.indexOf("?")>-1?"&":"?")+e;var f=m.create("<iframe>",b);return f.setAttribute("width",1),f.setAttribute("height",1),f.style.position="absolute",m.get(c||"body").appendChild(f)}function g(a,b){v?f(a,b):w.push([a,b])}function h(a){var b=a.src,c=/childFlash=([^&]+)/;if(b){var d=b.match(c);if(d&&d[1])return d[1];throw"iframe has no flashName param"}}function i(){return!1}var j,k=window,l=a.namespace("TBC.Messenger"),m=a.DOM,n=(a.Event,a.UA,a.JSON),o=(document.domain,"undefined"==typeof postMessage||!k.addEventListener),p=-1===location.host.indexOf("daily")&&-1===location.host.indexOf("net"),q=location.protocol<"https",r=q?"//g."+(p?"tbcdn.cn":"assets.daily.taobao.net"):"//"+(p?"s.tbcdn.cn/g":"assets.daily.taobao.net"),s="1.4.20",t=parseFloat(s)?r+"/tbc/umpp/"+s+"/flash-post-message.swf":"flash-post-message.swf",u=[],v=!o,w=[],x="_MessengerFlash_"+a.now();if(!i()||o)if(o){var y=!(a.version<=1.2||a.version>=1.4);a.use(y?"swf":"flash",function(a,b){window._Messenger_Flash_PostMessage=function(a,b){var c=b.type,d=b.msg;if("swfReady"===c){v=!0;for(var g;g=w.pop();)f.apply(null,g)}else"message"==c&&d&&e(d.type,d.content)};var c={src:t,attrs:{width:1,height:1,style:"position:absolute;top:0",id:"umpp-message-id",name:"umpp-message-name"},params:{flashVars:{jsentry:"_Messenger_Flash_PostMessage",swfid:"J_MessengerFlashPostMessage",name:x},allowscriptaccess:"always"}};b&&y?j=new b(c):a.Flash&&a.Flash.add&&a.Flash.add("#J_FlashPostMessageContainer",c,function(a){j=a.swf})})}else k.addEventListener("message",function(b){var c=b.data;if(c&&a.isString(c))try{var d=n.parse(c);e(d.type,d.content)}catch(f){}},!1);else v=!0;return a.mix(l,{register:b,unregister:c,send:d,createIframe:g,fire:e,flashName:x})},{requires:["core"]}),KISSY.add("tbc/umpp/1.4.20/mods/getNick",function(a){var b=a.namespace("TBC.umpp");return b.getNick=function(b){var c=a.Cookie.get("_nk_")||a.Cookie.get("lgc");return b&&c?encodeURIComponent(unescape(c.replace(/\\u/g,"%u"))):c}},{requires:["cookie"]}),KISSY.add("tbc/umpp/1.4.20/mods/trinity",function(a){function b(a,b,c){this.nick=a||"umpp-guest",this.swfurl=b,this.evs=c,this._init()}var c=a.DOM,d=(a.JSON,a.namespace("TBC.umpp")),e="UM_",f=window,g="J_UmppUserContainer",h="_umpp_trinity_",i=b.prototype;return i._init=function(){var b=this,d={src:b.swfurl,attrs:{width:1,height:1,id:"umpp-trinity-id",name:"umpp-trinity-name"},params:{flashVars:{jsentry:h,swfid:e+b.nick+a.now(),group:b.nick},allowscriptaccess:"always"}};f[h]=function(a,c){var d=c.type,e=c.data,f=b.evs,g=f[d];g&&g.call(b,"message"===d?e:null)};var i=!(a.version<=1.2||a.version>=1.4);a.use(i?"swf":"flash",function(a,e){i&&e?b.swf=new e(d):a.Flash&&a.Flash.add&&(c.get("#"+g)||document.body.appendChild(c.create('<div id="'+g+'" style="height:1px;width:1px;overflow:hidden;position:absolute;bottom:1px"></div>')),a.Flash.add("#"+g,d,function(a){b.swf=a.swf}))})},i.fire=function(a,b){return this.swf.callSWF?this.swf.callSWF("fire",[a,b]):(this.swf.fire(a,b),void 0)},i.destroy=function(){var a=this;try{a.swf.destroy?a.swf.destroy():c.remove("#"+g),delete f[h]}catch(b){}},d.Trinity=b},{requires:["dom","json"]}),KISSY.add("tbc/umpp/1.4.20/mods/initGuest",function(a){function b(b,f,g){return e._guestTimer=setTimeout(function(){a.getScript(parseFloat(c)?f+"/tbc/umpp/"+c+"/guest-min.js":"guest.js",function(){parseFloat(a.version,10)>1.1&&a.use(parseFloat(c)?"tbc/umpp/"+c+"/guest":"tbc/umpp/guest")})},d),a.mix(e,{isOnline:b,cdnPath:f,Trinity:g}),e}var c="1.4.20",d=18e4,e=a.namespace("TBC.umpp");return a.mix(e,{register:function(){},send:function(){},destroy:function(){this.trinity&&(this.trinity.destroy(),delete this.trinity),this._guestTimer&&(clearTimeout(this._guestTimer),this._guestTimer=null)}}),e.initGuest=b}),KISSY.add("tbc/umpp/1.4.20/mods/initUser",function(a){function b(a){n.get("#"+p)||o.createIframe({src:a,id:p,frameborder:0,scrolling:"no"})}function c(b){a.isArray(b)&&b.length&&a.each(b,function(a){"1063"==a.t1&&t.trinity.fire({content:[a],identity:[t.nick,a.t1,"1"].join("-")})})}function d(){o.register("umppready",function(){l=!0,f("master"),f("join")}),o.register("umppdata",function(a){t.notify(a,!0),c(a)})}function e(b,c){if(!c)return!1;var d=c.body,e=d.content;if(a.isObject(d))if("-"===d.identity)a.each(e,function(b){a.each(t._Events,function(a){a&&b.t1==a[0]&&a[1](b)})});else if(q===d.type)if(j){var g=e[0],h=e[1];"umpp-store-get"===g?t.getItem(h,function(a){b.fire.call(b,{type:q,content:[h,a]},c.from)}):"umpp-store-remove"===g?t.removeItem.call(t,h):"umpp-store-set"===g?t.setItem.apply(t,h):t.send(g,h)}else{var e=d.content;o.fire("umpp-store-get-"+e[0],e[1])}else if(r===d.type){if(!d.includeSelf&&c.from===c.to)return!1;f("message",d.content)}}function f(b,c){a.each(t._SwfEvents,function(a){a&&b===a[0]&&(a[1](c),"message"!==b&&(a[0]=b+"_ed"))})}function g(a){b("//mpp."+(a?"taobao.com":"daily.taobao.net:8080")+"/ajaxconn2.html?appId="+s),l&&f("master")}function h(c,h,i,m){t.trinity=new c(h,i,{master:function(){j=!0,d(),new a.IO({url:"//allot.mpp."+(m?"taobao.com":"daily.taobao.net")+"/allot.do?appId="+s,dataType:"jsonp",timeout:3,success:function(a){if(a&&0==a.code){var c=a.tn?a[a.tn]:a.token;c&&(c="&"+(a.tn?a.tn:"token")+"="+c),b("//"+a.host+"/ajaxconn2.html?appId="+s+c),l&&f("master")}else a&&1111==a.status&&g(m)},error:function(){g(m)}})},join:function(){k=!0,(j&&l||!j)&&f("join")},message:function(a){e(this,a)}})}function i(a,b,c,d,e){var f=parseFloat(m)?b+"/tbc/umpp/1.4.2/trinity.swf":"trinity.swf";return t.nick=c,h(d,c,f,a),t.on("join",function(){new e({mc:t})}),t}var j,k,l,m="1.4.20",n=a.DOM,o=a.TBC.Messenger,p="J_Um_Iframe",q="_trinity_notify_private",r="_trinity_notify_public",s=-1===location.host.indexOf("meeting.wangwang")?1064:1065,t=a.namespace("TBC.umpp");return a.mix(t,{_Events:[],_SwfEvents:[],_StoreCache:{},_storeData:function(a,b){j&&(this._StoreCache[a]=b)},_removeData:function(a){j&&this._StoreCache[a]&&delete this._StoreCache[a]},on:function(a,b){return(j&&l||!j&&k)&&("master"===a&&j||"join"===a&&k)?(b(),!0):this._SwfEvents.push([a,b])-1},off:function(b){return a.isNumber(b)?this._SwfEvents[b]=null:void 0},register:function(a,b,c){var d=this,e=function(e,f){b(e,f),c?d._storeData(a,e):d.removeItem(a)};return d.getItem(a,function(a){a&&e(a,!0)}),d._Events.push([a,e])-1},unregister:function(a){return this._Events[a]=null},send:function(a,b){return j?o.send.call(null,a,b,p):(this.trinity&&this.trinity.fire({type:q,content:[a,b]},"_"+this.nick),void 0)},notify:function(a,b){return this.trinity.fire({type:r,content:a,includeSelf:b,identity:"-"})},setItem:function(a,b){var c=this;c.on("join",function(){c._storeData(a,b),c.send("umpp-store-set",[a,b])})},getItem:function(a,b){var c=this,d=this._StoreCache[a];j&&d?b(d):c.on("join",function(){var d=o.register("umpp-store-get-"+a,function(e){o.unregister(d),c._storeData(a,e),b(e)});c.send("umpp-store-get",a)})},removeItem:function(a){var b=this;b.on("join",function(){b._removeData(a),b.send("umpp-store-remove",a)})},clear:function(a){return this.send("clearTMsg",a)},destroy:function(){this.trinity&&(this.trinity.destroy(),delete this.trinity),n.remove("#"+p),j=void 0,k=void 0,l=void 0,this._StoreCache={}}}),t.initUser=i},{requires:["core"]}),KISSY.add("tbc/umpp/1.4.20/mods/monitorevent",function(a,b){function c(b){this.cfg=a.merge({delay:2e4},b||{}),this.status=1,this._init()}return a.mix(c.prototype,{get:function(a){return this.cfg[a]},set:function(a,b){this.cfg[a]=b},_init:function(){var b=window.g_config;return b?!b.appId||1!=b.appId&&1009!=b.appId?!1:(this.itemId=b.itemId,this.itemId?(this.activeTime=a.now(),this.cfg.mc.send("umpp-monitor-event",[this.itemId,1,this.activeTime].join(",")),this.timer=null,this._bindEvent(),this._addTimer(),this._registerUmppEvent(),void 0):!1):!1},_bindEvent:function(){var a=this;b.on(window,"focus",function(){a._active.call(a),a._focus.call(a)}),b.on(window,"blur",function(){a._active.call(a),a._blur.call(a,!0)}),b.on(window,"mousemove scroll",function(){a._active.call(a)}),b.on(window,"beforeunload",function(){a._close.call(this)})},_registerUmppEvent:function(){var a=this,b=a.cfg.mc;b.register("monitor-start",function(){a.start.call(a)}),b.register("monitor-focustime",function(b){a.set.call(a,"delay",1e3*b.focustime)})},_focus:function(){this.set("focusbluring",!1),this.status&&(this._removeTimer(),this.timer||this._addTimer(),this.cfg.mc.send("umpp-monitor-event",[this.itemId,2,a.now()].join(",")),console.log("focus"))},_blur:function(b){this.set("focusbluring",!1),this.status&&(b&&this._removeTimer(),console.log("blur"),this.cfg.mc.send("umpp-monitor-event",[this.itemId,3,a.now()].join(",")))},_active:function(){this.activeTime=a.now()},_close:function(){console.log("close"),this.status&&this.cfg.mc.send("umpp-monitor-event",[this.itemId,4,a.now()].join(","))},_addTimer:function(){var b=this;b.timer=setTimeout(function(){var c=a.now();c-b.activeTime>b.cfg.delay&&!b.get("focusbluring")&&(b._blur(),b.set("focusbluring",!0),console.log("focus to blur")),b.timer=setTimeout(arguments.callee,b.cfg.delay)},b.cfg.delay)},_removeTimer:function(){this.timer&&(clearTimeout(this.timer),this.timer=null)}}),c},{requires:["event"]}),KISSY.add("tbc/umpp/1.4.20/index",function(a,b,c,d,e,f,g,h){function i(){var b,c=a.Cookie,d=-1===location.host.indexOf("daily"),e=c.get("_l_g_")||c.get("lgc"),f=location.protocol<"https",g=f?"//g."+(d?"tbcdn.cn":"assets.daily.taobao.net"):"//"+(d?"s.tbcdn.cn/g":"assets.daily.taobao.net"),i=j._Events,k=j._SwfEvents;return b=e?j.initUser(d,g,j.getNick(!0),j.Trinity,h):j.initGuest(d,g,j.Trinity),i&&a.mix(b,{_Events:i}),k&&a.mix(b,{_SwfEvents:k}),a.mix(j,b)}a.version>=1.4&&a.config({modules:{ajax:{alias:["io"]},flash:{alias:["gallery/flash/1.0/"]}}});var j=a.namespace("TBC.umpp");return j.init=i,i()},{requires:["core","tbc/umpp/1.4.20/mods/messenger","tbc/umpp/1.4.20/mods/getNick","tbc/umpp/1.4.20/mods/trinity","tbc/umpp/1.4.20/mods/initGuest","tbc/umpp/1.4.20/mods/initUser","tbc/umpp/1.4.20/mods/monitorevent"]});