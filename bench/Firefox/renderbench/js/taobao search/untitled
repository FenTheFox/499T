/*! datalazyload - v1.0 - 2013-05-14 2:49:42 PM
* Copyright (c) 2013 kissy-team; Licensed  */
KISSY.add("gallery/datalazyload/1.0/plugin/webp",function(){return function(){this.WebP||(this.WebP={},WebP._cb=function(t,e){this.isSupport=function(e){e(t)},e(t),(window.chrome||window.opera&&window.localStorage)&&window.localStorage.setItem("webpsupport",t)},WebP.isSupport=function(t){if(t){if(!window.chrome&&!window.opera)return WebP._cb(!1,t);if(window.localStorage&&null!==window.localStorage.getItem("webpsupport")){var e=window.localStorage.getItem("webpsupport");return WebP._cb("true"===e,t),void 0}var a=new Image;a.src="data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA",a.onload=a.onerror=function(){WebP._cb(2===a.width&&2===a.height,t)}}},WebP.run=function(t){this.isSupport(function(e){e&&t()})})}(),window.WebP},{attach:!1,requires:[]}),KISSY.add("gallery/datalazyload/1.0/index",function(t,e,a,o,n,r){function i(a,o,n){a.style.display=w,a.className="";var r=e.create("<div>");a.parentNode.insertBefore(r,a);var i=a.value;if(t.isFunction(n)){var s=n({type:"textarea",elem:a,value:i});s&&(i=s)}e.html(r,i,o)}function s(e,a){var o,n;return(o=e.id)||(o=e.id=t.guid("ks-lazyload")),(n=a.ksLazyloadId)||(n=a.ksLazyloadId=t.guid("ks-lazyload")),o+n}function c(t){return t._ks_lazy_width?t._ks_lazy_width:t._ks_lazy_width=e.outerWidth(t)}function l(t){return t._ks_lazy_height?t._ks_lazy_height:t._ks_lazy_height=e.outerHeight(t)}function u(t,a,o){if(!t.offsetWidth)return!1;var n,r=e.offset(t),i=!0,s=r.left,u=r.top,d={left:s,top:u,right:s+c(t),bottom:u+l(t)};return n=f(a,d),n&&o&&(i=f(o,d)),i&&n}function d(e,a){var o=this;if(!(o instanceof d))return new d(e,a);var n=e;t.isPlainObject(n)||(n=a||{},e&&(n.container=e)),d.superclass.constructor.call(o,n),o._callbacks={},o._containerIsNotDocument=9!=o.get("container").nodeType,o._initLoadEvent()}function f(t,e){var a={};return a.top=Math.max(t.top,e.top),a.bottom=Math.min(t.bottom,e.bottom),a.left=Math.max(t.left,e.left),a.right=Math.min(t.right,e.right),a.bottom>=a.top&&a.right>=a.left}function g(a,o,n,r){"img-src"===o&&(o="img"),t.isArray(a)||(a=[e.get(a)]);var s=n||p+y,c=n||v+y;t.each(a,function(t){var a=e.nodeName(t);"img"==o?"img"==a?z(t,s,r):e.query("img",t).each(function(t){z(t,s,r)}):"textarea"==a?e.hasClass(t,c)&&i(t,!0,r):e.query("textarea."+c,t).each(function(t){i(t,!0,r)})})}function m(t){n.isSupport(t)}var _=t.Env.host,h=_.document,p="data-ks-lazyload",v="ks-datalazyload",y="-custom",b="default",w="none",A="scroll",k="touchmove",I="resize",x=100,z=function(e,a,o){a=a||p;var n=e.getAttribute(a);if(n&&e.src!=n){if(t.isFunction(o)){var r=o({type:"img",elem:e,src:n});r&&(n=r)}e.src=n,e.removeAttribute(a)}};return d.ATTRS={diff:{value:b},placeholder:{value:"http://a.tbcdn.cn/kissy/1.0.0/build/imglazyload/spaceball.gif"},execScript:{value:!0},container:{setter:function(a){return a=a||h,t.isWindow(a)?a=a.document:(a=e.get(a),"body"==e.nodeName(a)&&(a=a.ownerDocument)),a},valueFn:function(){return h}},autoDestroy:{value:!0},onStart:{vaule:null}},t.extend(d,o,{_filterItems:function(){var a=this,o=a.userConfig,n=a.get("container"),r=[],i=[],s=[n];t.isArray(o.container)&&(a._backCompact=1,s=o.container),t.each(s,function(o){r=r.concat(t.filter(e.query("img",o),a._filterImg,a)),i=i.concat(e.query("textarea."+v,o))}),a._images=r,a._textareas=i},_filterImg:function(t){var e=this,a=e.get("placeholder");return t.getAttribute(p)?(t.src||(t.src=a),!0):r},_initLoadEvent:function(){function e(){a._filterItems(),a._isLoadAllLazyElements()||t.ready(i),a.resume()}var a=this,o=new Image,n=a.get("placeholder"),r=a.get("autoDestroy"),i=function(){a._loadItems(),r&&a._isLoadAllLazyElements()&&a.destroy()};a._loadFn=t.buffer(i,x,a),o.src=n,o.complete?e():o.onload=e},refresh:function(){this._loadFn()},_loadItems:function(){var t,e,a=this,o=a.get("container");(!a._containerIsNotDocument||o.offsetWidth)&&(e=a._getBoundingRect(),!a._backCompact&&a._containerIsNotDocument&&(t=a._getBoundingRect(a.get("container"))),a._loadImgs(e,t),a._loadTextAreas(e,t),a._fireCallbacks(e,t))},_loadImgs:function(e,a){var o=this;o._images=t.filter(o._images,function(t){return u(t,e,a)?z(t,r,o.get("onStart")):!0},o)},_loadTextAreas:function(e,a){var o=this,n=o.get("execScript");o._textareas=t.filter(o._textareas,function(t){return u(t,e,a)?i(t,n,o.get("onStart")):!0},o)},_fireCallbacks:function(e,a){var o=this,n=o._callbacks;t.each(n,function(t,o){var r=t.el,i=!1,s=t.fn;u(r,e,a)&&(i=s.call(r)),i!==!1&&delete n[o]})},addCallback:function(t,a){var o=this,n=o._callbacks;t=e.get(t),n[s(t,a)]={el:e.get(t),fn:a},o._loadFn()},removeCallback:function(t,a){var o=this._callbacks;t=e.get(t),delete o[s(t,a)]},getElements:function(){return{images:this._images,textareas:this._textareas}},addElements:function(a){"string"==typeof a?a=e.query(a):t.isArray(a)||(a=[a]);var o=this,n=o._images||[],r=o._textareas||[];t.each(a,function(e){var a=e.nodeName.toLowerCase();"img"==a?t.inArray(e,n)||n.push(e):"textarea"==a&&(t.inArray(e,r)||r.push(e))}),o._images=n,o._textareas=r},removeElements:function(a){"string"==typeof a?a=e.query(a):t.isArray(a)||(a=[a]);var o=this,n=[],r=[];t.each(o._images,function(e){t.inArray(e,a)||n.push(e)}),t.each(o._textareas,function(e){t.inArray(e,a)||r.push(e)}),o._images=n,o._textareas=r},_getBoundingRect:function(a){var o,n,i,s;if(a!==r){o=e.outerHeight(a),n=e.outerWidth(a);var c=e.offset(a);i=c.left,s=c.top}else o=e.viewportHeight(),n=e.viewportWidth(),i=e.scrollLeft(),s=e.scrollTop();var l=this.get("diff"),u=l===b?n:l,d=0,f=u,g=l===b?o:l,m=0,_=g,h=i+n,p=s+o;return t.isObject(l)&&(d=l.left||0,f=l.right||0,m=l.top||0,_=l.bottom||0),i-=d,h+=f,s-=m,p+=_,{left:i,top:s,right:h,bottom:p}},_isLoadAllLazyElements:function(){var e=this;return 0==e._images.length+e._textareas.length+(t.isEmptyObject(e._callbacks)?0:1)},pause:function(){var t=this,e=t._loadFn;if(!t._destroyed&&(a.remove(_,A,e),a.remove(_,k,e),a.remove(_,I,e),e.stop(),t._containerIsNotDocument)){var o=t.get("container");a.remove(o,A,e),a.remove(o,k,e)}},resume:function(){var t=this,e=t._loadFn;if(!t._destroyed&&(a.on(_,A,e),a.on(_,k,e),a.on(_,I,e),t._containerIsNotDocument)){var o=t.get("container");a.on(o,A,e),a.on(o,k,e)}},destroy:function(){var e=this;e.pause(),e._callbacks={},e._images=[],e._textareas=[],t.log("datalazyload is destroyed!"),e.fire("destroy"),e._destroyed=1}}),d.loadCustomLazyData=g,d.isWebpSupported=m,t.DataLazyload=d,d},{requires:["dom","event","base","./plugin/webp"]});