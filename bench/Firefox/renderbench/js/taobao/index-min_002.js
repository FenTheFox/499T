/*! search-suggest 2013-08-29 */
KISSY.add("tbc/search-suggest/1.0.14/suggest",function(a,b){function c(a){c.superclass.constructor.call(this,a||{})}return c.RemoteDataSource=b.RemoteDataSource,a.extend(c,b,{initializer:function(){},sendRequest:function(a){var b=this,c=b.constructor.superclass.sendRequest;b.fire("beforeQueryChange",{query:a})!==!1&&c.apply(this,arguments)},handleKeyEventInternal:function(a){var b=this,c=b.constructor.superclass.handleKeyEventInternal;b.fire("beforeKeyDown",{event:a})!==!1&&c.apply(this,arguments)},setValueInternal:function(a){var b=this,c=b.constructor.superclass.setValueInternal;b.fire("beforeSetInputValue",{event:a})!==!1&&c.apply(this,arguments)},renderItems:function(b,c,d){var e,f,g=this,h=g.get("sugConfig").resultFormat,i=g.resultArr||(g.resultArr=[]),j="",k=b;a.each(c,function(b,g){if(!b||!b[0])return c.splice(g,1),void 0;for(e=b[0];e.indexOf(k)<0;)k=k.substr(0,k.length-1);""===k?(j=e,e=""):0===e.indexOf(k)&&(j=k,e=e.replace(k,""));for(var l in i)if(f=i[l],f.textContent===b[0]&&f.unique)return;d=d.replace("{format}",h),i.push({textContent:b[0],content:a.substitute(d,{query:j,text:e,index:g+1,count:b[1]}),list:!0})}),g.resultArr=i},alignInternal:function(a){var b=this,c=b.constructor.superclass.alignInternal;b.fire("beforeShow",{event:a})!==!1&&c.apply(this,arguments)}},{ATTRS:{dataSourceCfg:{value:{xhrCfg:{url:"",dataType:"jsonp",scriptCharset:"utf-8",data:{code:"utf-8"}},allowEmpty:!0,paramName:"q",cache:!0}},mods:{value:{},setter:function(a){return a}}}}),c},{requires:["combobox"]}),KISSY.add("tbc/search-suggest/1.0.14/plugin/mods",function(){return{"new":{tmpl:'<div class="item-wrapper {prefixCls}menu-extras-xp" data-key="q={$query}&suggest=new_{$index}&tab=shopping&auction_tag[]=1154"><span class="{prefixCls}menu-xp-tag">\u65b0\u54c1</span><span class="{prefixCls}menu-xp-icon">\u65b0\u54c1</span><span class="{prefixCls}menu-xp">\u201c{$query}\u201d\u76f8\u5173{new}\u65b0\u54c1</span></div>'},shop:{tmpl:'<div class="item-wrapper {prefixCls}menu-extras-dp" data-action="http://shopsearch.taobao.com/search" data-key="q={$query}&suggest=shop_{$index}"><span class="{prefixCls}menu-dp-icon">\u5e97\u94fa</span><span class="{prefixCls}menu-dp">\u201c{$query}\u201d\u76f8\u5173\u5e97\u94fa</span></div>'},cat:{tmpl:'<div class="{prefixCls}menu-extras-cate" data-key="q={$query}&cat={$1}&suggest=cat_{$index}"><span class="{prefixCls}menu-key">{$query}</span><span class="{prefixCls}menu-cate">\u5728<b>{$0}</b>\u5206\u7c7b\u4e0b\u641c\u7d22</span></div>'},list:{tmpl:"<div data-index='{index}' class='item-wrapper' data-key='q={textContent}&suggest=0_{index}'><span class='item-text'>{query}<b>{text}</b></span><span class='item-count'>{format}</span></div>"},global:{tmpl:'<div class="{prefixCls}menu-extras-cate" data-key="q={$query}&promote=2097152&suggest=global_{$index}"><span class="{prefixCls}menu-key">{$query}</span><span class="{prefixCls}menu-cate">\u5728\u5168\u7403\u8d2d\u5e02\u573a\u4e2d\u641c\u7d22</span></div>'},showExtra:!1}}),KISSY.add("tbc/search-suggest/1.0.14/index",function(a,b,c,d,e,f){b.all;var g=c.extend([],{initializer:function(){var a=this;a._initCombo()},_setComboCache:function(a){var b=this,c=b.get("tab");b.configArr=b.configArr||[],b.configArr[c]={data:a}},_checkHasTab:function(){var a=this,b=a.getPlugin("tab");b||(a.tabNode=a.comboBox.get("input").parent("form"))},_initComboEvent:function(){var b=this,c=b.comboBox,e=c.get("input");e.on("mousedown",function(d){if(b.fire("beforeFocus")!==!1){var f=a.trim(e.val()),g=b.get("sugConfig"),h=(g.prefixCls,!0);h&&(g.autoCollapsed||""===f)&&c.sendRequest(f)}d.stopPropagation()}),e.on("focus",function(){b.fire("beforeFocus")}),e.on("blur",function(){b.fire("beforeBlur")}),c.on("click",b.comboClick,b),c.on("afterCollapsedChange",b._addExtraEvent,b),c.on("afterCollapsedChange",function(a){b.fire("afterCollapsedChange",a)}),c.on("beforeSetInputValue",function(){var a=b.get("label");a&&d.hide(a)}),b._formSubmitEvent(),b.query=e.val()},_formSubmitEvent:function(){var b,c,d,e,f=this,g=f.comboBox,h=g.get("input"),i=h.parent("form"),j="",k=g.get("input");i.on("submit",function(g){if(f.fire("beforeSubmit",{el:i,isInitSearch:!0})!==!1){if(b=i.attr("action"),c=b.split("?")[1],""===a.trim(k.val())&&f._emptyJump(i)===!1&&g.preventDefault(),c){d=c.split("&");for(var h in d)e=d[h].split("="),j+='<input type="hidden" name="'+e[0]+'" value="'+e[1]+'"/>';i.append(j)}}else g.halt()})},_defaultPageJump:function(b){var c,d=this,e=d.tabNode;if(!e)return!1;if(c=b.attr("data-defaultpage")||e.attr("data-defaultpage")){if(!a.startsWith(c,"http"))return!1;b.attr("action",c)}},_emptyJump:function(a){var b,c=this,d=a.one("label"),e=c.get("sugConfig");return e.tab,d?(b=d.one("span"),b&&""!==b.text()?(d.hide(),c._holderJump(a,b.text()),void 0):c._defaultPageJump(a)):c._defaultPageJump(a)},_holderJump:function(a,b){var c=a[0].q;c&&(c.value=b),a.append('<input type="hidden" name="style" value="grid" />')},comboClick:function(a){var c=this,e=a.target.get?a.target.get("el"):b.one(a.currentTarget),f=c.comboBox;c.fire("beforeSubmit",{el:e,isInitSearch:!1});var g=c.query,h=c.query,i=d.children(e),j=d.attr(i,"data-key")||"q="+g,k=d.parent(f.get("el"),"form"),l=d.attr(k,"action"),m=d.attr(i,"data-action")||c.get("action")||l,n="&wq="+h+"&suggest_query="+g+"&source=suggest",o=c._getInputsVal(k);m+=m.indexOf("?")>-1?"&":"?",c.redirect(m+j+n+o)},redirect:function(a){var b=document.createElement("a");b.setAttribute("href",a),b.setAttribute("target","_self"),b.style.display="none",document.body.appendChild(b),b.click()},_getInputsVal:function(b){var c,e,f=this,g=f.get("sugConfig"),h=g.excludeParam,i=[];inputs=d.query("input",b);for(var j=inputs.length-1;j>=0;j--)c=inputs[j],e=c.name,e&&!a.inArray(e,h)&&i.push(e+"="+encodeURIComponent(c.value));return i.length<1?"":"&"+i.join("&")},_getDefComboCfg:function(){return{focused:!1,hasTrigger:!1,matchElWidth:!0,srcNode:".allWidth",highlightMatchItem:!1,menu:{align:{overflow:{adjustY:0}}},cache:!0}},_prepareHtml:function(a,c){var e=this,f='<div class="{cls}combobox"><div class="{cls}combobox-input-wrap"></div></div>',g=f.replace(/{cls}/g,c),h=d.create(g),i=(this.getPlugin("history"),{"aria-haspopup":"true","aria-combobox":"list",role:"combobox",autocomplete:"off","class":c+"combobox-input","x-webkit-speech":"","x-webkit-grammar":"builtin:translate"});return d.attr(a,"aria-label")||(i.title=i["aria-label"]=e._isOpen("history")?"\u8bf7\u8f93\u5165\u641c\u7d22\u6587\u5b57\u6216\u4ece\u641c\u7d22\u5386\u53f2\u4e2d\u9009\u62e9":"\u8bf7\u8f93\u5165\u641c\u7d22\u6587\u5b57"),d.attr(a,i),d.wrap(a,h),this.get("sugConfig").focused&&d.get(a).focus(),b.one("."+c+"combobox")},_isOpen:function(b){var c=this,d=c.get("mods"),e=d.sort;return a.inArray(b,e)},_getRenderMods:function(){var b=this,c=a.merge(f,b.get("mods"));b.set("mods",c)},_getDataSourceCfg:function(){var b=this,c=b.get("sugConfig"),d=b.get("dataSourceCfg");return d.xhrCfg.url=c.sourceUrl,d.parse=a.bind(b.parse,b),d},_getComboCfg:function(c){var d=this,e=d.get("sugConfig"),f=d._getDefComboCfg();return f.srcNode=d._prepareHtml(e.node,e.prefixCls),f.dataSource=c,f.format=a.bind(d.format,d),f.prefixCls=e.prefixCls,f.placeholderEl=b.one(e.placeholderEl),f},_initCombo:function(){var a,b,c=this,d=c._getDataSourceCfg();c._getRenderMods(),a=new e.RemoteDataSource(d),c._setComboCache(a),b=c._getComboCfg(a);var f=new e(b);f.render(),c.comboBox=f,c._checkHasTab(),c._initComboEvent()},update:function(b){for(var c=this,d=c.get("plugins"),e=0,f=d.length-1;f>=e;e++){var g=d[e];g&&a.isFunction(g.update)&&g.update.call(g,b)}},parse:function(a,b){var c=this,d=c.fire("beforeParse",{results:b,query:a});if(d===!1)return[[""]];if(d&&(b=d),!b.result)return[[""]];var c=this,e=b.result;delete b.result;var f=c.comboBox.get("dataSource");if((f.extraData||(f.extraData=[]))[a]=b,0===e.length)return[[""]];for(var g in e)e[g]||e.splice(g,1);return e},format:function(a,b){var c=this;return c.resultArr=[],c.render(a,b),c.resultArr},render:function(a,b){var c,d,e,f,g,h,i=this,j=i.get("mods"),k=j.sort,l=i._adjustExtra(a,j.showExtra);i.query=a;for(var m=0,n=k.length-1;n>=m;m++)if(h=k[m])if("list"!==h){if(g=i.getPlugin(h),g&&g.renderPlugin)g.renderPlugin({query:a,results:b});else if(d=j[h],d&&l&&(!(f=d.pos)||e!==f)){if(c=d.tmpl,!c)continue;var o=i.resultArr.length,p=i.diffLen||0;e=i.defaultRender({tmpl:c,name:h,pos:f,always:d.always&&b.length>0,callback:d.callback,index:o-p})}}else d=j[h],c=d.tmpl,i._list(a,b,c);i.fire("afterQueryChange",{query:a})},defaultRender:function(b){var c,d=this,e=b.tmpl,f=b.name,g=d.comboBox.get("dataSource"),h=d.query,i=d.get("sugConfig").prefixCls,j=g.extraData,k=b.pos,l=b.index;if(j&&j[h]||b.always){var m=d._getDate(),n={$query:h,$date:m,prefixCls:i};if(!b.always){var o=j[h][f],p=!0;if(!o)return;if(a.isArray(o)){o.length>2&&(o.length=2);for(var q=0,r=o.length-1;r>=q;q++){var s=o[q];if(a.isArray(s)){p=!1;for(var t=0,u=s.length-1;u>=t;t++)n["$"+t]=s[t]||"";n.$index=l+1+q,c=a.substitute(e,n),d.addContent({html:c,query:h,position:k,callback:b.callback})}else n["$"+q]=s,n.$index=l+1+q}return p&&(c=a.substitute(e,n),d.addContent({html:c,query:h,position:k,callback:b.callback})),k}n[f]=o}return n.$index=l+1,c=a.substitute(e,n),d.addContent({html:c,query:h,position:k,callback:b.callback}),k}},_adjustExtra:function(a){return""!==a?!0:!1},getNick:function(){var a=this;return a._getCookie("_nk_")||a._getCookie("tracknick")},_getCookie:function(b){var c=window;if(c.userCookie&&!a.isUndefined(c.userCookie[b]))return c.userCookie[b];if(c.SRP_COOKIES||(c.SRP_COOKIES={})&&a.isUndefined(SRP_COOKIES[b])){var d=document.cookie.match("(?:^|;)\\s*"+b+"=([^;]*)");SRP_COOKIES[b]=d&&d[1]?decodeURIComponent(d[1]):""}return SRP_COOKIES[b]},_getDate:function(){var a=new Date;return a.getFullYear()+"-"+(a.getMonth()+1)+"-"+(a.getDate()+1)},_list:function(b,c,d){var e,f=this,g=f.get("sugConfig").resultFormat,h=f.resultArr||(f.resultArr=[]);a.each(c,function(f,i){if(!f||!f[0])return c.splice(i,1),void 0;var j,k=f[0],l="",m=b;if(k.match(/<b>/))e=k.replace(/<b>(\S+?)<\/b>/g,function(a,b){return b}),l=k,k="";else{for(;k.indexOf(m)<0;)m=m.substr(0,m.length-1);""===m?(l=k,k=""):0===k.indexOf(m)&&(l=m,k=k.replace(m,"")),e=f[0]}for(var n in h)if(j=h[n],j.textContent===f[0]&&j.unique)return;d=d.replace("{format}",g),h.push({textContent:e,content:a.substitute(d,{query:l,text:k,index:i+1,count:f[1],textContent:e}),list:!0})}),f.resultArr=h},addContent:function(a){var b=this,c=a.html,d=a.position,e=a.query;if(!d){var f=b.resultArr||[];return f.push({content:c,textContent:e}),void 0}b["__"+d]={tmpl:c},b._addExtraEvent()},_renderHeader:function(a,c,d){var e=c&&c.type+"-header"||"";if(c){var f=this.get("sugConfig").prefixCls;a||(a=new b("<div class='"+f+"combobox-menu-header "+e+"'></div>").prependTo(d)),a.empty().append(c.tmpl)}else a&&a.remove()},_renderFooter:function(a,c,d){var e=this,f=e.get("sugConfig").prefixCls,g=c&&c.type+"-footer"||"";if(c){a||(a=new b("<div class='"+f+"combobox-menu-footer "+g+"'></div>").appendTo(d)),c.css&&a.css(c.css),a.empty().append(c.tmpl);var h=a.one("."+f+"menu-history-clean");h&&h.on("click",function(a){a.halt();var b=e.getPlugin("history");b._cleanHistory()})}else a&&a.remove()},_addExtraEvent:function(a){var b=this,c=b.comboBox||b,d=b.__header,e=b.__footer,f=b.__lastHeader,g=b.__lastFooter,h=b.get("sugConfig").prefixCls;if(!a||a&&!a.newVal){var i=c.get("menu");if(!i.get)return;var j=i.get("el");if(!j||j.all("."+h+"menuitem").length<1)return;var k=j.one("."+h+"combobox-menu-header"),l=j.one("."+h+"combobox-menu-footer");f!==d&&(b.__lastHeader=d,b._renderHeader(k,d,j)),g!==e&&(b.__lastFooter=e,b._renderFooter(l,e,j))}else b.__header=null,b.__footer=null}},{ATTRS:{sugConfig:{value:{extraPassParams:"",extraPostParams:"",sourceUrl:"",tab:"item",autoCollapsed:!0,focused:!1,prefixCls:"search-",excludeParam:["q"],resultFormat:"\u7ea6{count}\u4e2a\u5b9d\u8d1d"},setter:function(b){var c=this.get("sugConfig");return a.mix(c,b,void 0,void 0,!0)}},mods:{value:{},setter:function(a){return a}},input:{getter:function(a){return a||(a=this.comboBox.get("input"))}},form:{getter:function(a){return a||(a=this.get("input").parent("form"))}},label:{getter:function(a){return a||(a=this.comboBox.get("placeholderEl"))}},menu:{getter:function(a){return a||(a=this.comboBox.get("menu"))}},dataSourceCfg:{value:{xhrCfg:{url:"",dataType:"jsonp",scriptCharset:"utf-8",data:{code:"utf-8"}},allowEmpty:!0,paramName:"q",cache:!0}}}});return g},{requires:["node","rich-base","dom","./suggest","./plugin/mods"]});