/*! mini-cart 2014-02-12 */
KISSY.add("tbc/mini-cart/0.0.20/mods/cart",function(a,b,c,d,e){function f(b){if(a&&a.unparam)return h.userCookie&&"2"==h.userCookie.version?a.unparam(b,"&amp;"):a.unparam(b);if(b){for(var c=b.split("&"),d={},e=0;e<c.length;e++){var f=c[e].split("=");d[f[0]]=d[f[1]]}return d}return{}}TB.Global.miniCart={},a.mix(TB.Global.miniCart,d.Target),a.mix(TB.Global.miniCart,{NUM:{amount:0,promotionCount:0,quailtyTenseCount:0},setNum:function(b,c){var d={},e=!1;a.isPlainObject(b)?d=b:d[b]=c;var f=this.NUM;a.each(d,function(a,b){b in f&&(a!==f[b]&&(e=!0),f[b]=a)}),e&&this.fire("numChange"),this.fire("updateNum")},getNum:function(b){var c=this.NUM;return b?c[b]:a.clone(c)}});var g={},h=window,i=location.hostname.match(/\b(daily|com\.hk)\b/),j=i?"daily.taobao.net":"taobao.com",k="g_config"in h?"appId"in h.g_config?parseInt(h.g_config.appId):void 0:void 0;return a.mix(g,{cart_URL:"http://cart."+j+"/cart.htm",prom_URL:"http://cart."+j+"/cart.htm?extStatus=2",stock_URL:"http://cart."+j+"/cart.htm?extStatus=4",count_API:"http://cart."+j+"/json/AsyncGetMiniCount.do?",CARTNUM_API:"http://cart."+j+"/top_cart_quantity.htm?",CARTCDN_API:"http://count."+(i?"config-vip.taobao.net:8888":"tbcdn.cn")+"/counter6",TMS_API:"http://www.taobao.com/go/rgn/minicart.php?spm=0.0.0.0.OIDm7W"}),a.mix(g,d.Target),a.mix(g,{init:function(){this.isLogin=a.isFunction(TB.Global.isLogin)?TB.Global.isLogin():TB.Global.isLogin},getNum:function(a){return TB.Global.miniCart.getNum(a)},setNum:function(a,b){TB.Global.miniCart.setNum(a,b)},makePoint:function(a){if(a){var b=document.getElementById("J_ImageDot");b||(b=new Image,b.id="J_ImageDot",b.style.display="none",document.body.appendChild(b));var c=(new Date).getTime();a=-1!=a.indexOf("?")?a+"&cache="+c:a+"?cache="+c,b.src=a}},isTurnOff:function(){var a=f(e.get("mt")),b=a&&a.ci?a.ci.split("_"):[void 0,void 0],c=parseInt(b[0],10);return self._OFF=0>c,self._OFF},initAmount:function(){var a=this;a.getAmount(function(b){TB.Global.miniCart.setNum(b),a.fire("cartDataLoaded")})},getAmount:function(b){function d(f){if(f=f||0){var h={keys:"TCART_234_"+f+"_q",t:a.now()};c.jsonp(g.CARTCDN_API,h,function(a){if(a){var c=m>=0?m:r?1:0;b(a[h.keys]),e.set("mt","ci="+a[h.keys]+"_"+c+(n?"&"+n:""),7,j)}else r&&d()})}else{var i=g.CARTNUM_API+"t="+ +new Date+(k?"&appid="+k:"");c.jsonp(i,function(a){b({amount:a})})}}var g=this,h=f(e.get("mt")),i=h&&h.ci?h.ci.split("_"):[void 0,void 0],l=parseInt(i[0],10),m=parseInt(i[1],10),n=h?h.cp:void 0,o=h&&h.cyk?h.cyk.split("_"):[0,0],p=parseInt(o[0],10),q=parseInt(o[1],10),r=g.isLogin;g._OFF=0>l;var s="2.0"===TB.Global.version?!isNaN(TB.Global.util.getTag()):!0;if(r&&s)h&&1==m&&h.cyk&&-1!=p&&-1!=q?b({amount:l,promotionCount:p,quailtyTenseCount:q}):g.asyncGetMiniCartCount();else{var t=e.get("t");t?l>=0?b({amount:l}):d(t):b({amount:0})}},asyncGetMiniCartCount:function(){var b=this;try{new c({dataType:"jsonp",url:b.count_API+"&t="+ +new Date,jsonpCallback:"cb",success:function(c){a.each(c,function(a,b){c[b]=a>0?a:0}),c.amount=c.totleCount,TB.Global.miniCart.setNum(c),b.fire("cartDataLoaded")},error:function(){TB.Global.miniCart.setNum("amount",0)}})}catch(d){TB.Global.miniCart.setNum("amount",0)}},getTMSMsg:function(a){new c({dataType:"jsonp",url:this.TMS_API,jsonp:"cb",jsonpCallback:"shownotice",success:function(b){""!==b.text&&a(b)}})}}),g},{requires:["dom","ajax","event","cookie"]}),KISSY.add("tbc/mini-cart/0.0.20/index",function(a,b,c,d,e){var f,g={},h=0,i="mc-cart-idle";return a.mix(g,{init:function(){var d=this;if(!(h||"1.20"===a.version||TB.Global.miniCart&&TB.Global.miniCart.inited===!0)){h++,e.init(),TB.Global.miniCart.inited=!0;var g="J_miniCartPlugin";b.get("#"+g)&&b.remove("#"+g),d.containerEl=b.create('<div id="'+g+'" class="mini-cart-plugin"><div class="mc-cart-hover"><span></span></div><div class="mc-root mc-root-extend"><em class="mc-count" title="\u8d2d\u7269\u8f66\u603b\u6570">0</em><em class="mc-title">\u8d2d\u7269\u8f66</em><div class="mc-activity-area"></div></div></div>'),d.hoverEl=b.get(".mc-cart-hover",d.containerEl),d.rootEl=b.get(".mc-root",d.containerEl),d.amountEl=b.get(".mc-count",d.containerEl),d.activityAreaEl=b.get(".mc-activity-area",d.containerEl),b.append(d.containerEl,"body"),b.get("#tstart")&&b.css(d.containerEl,"right","65px"),d.checkHover=function(){var a=b.get(".mc-root-extend",d.containerEl);if(a){var c=b.get(".mc-msg",d.containerEl);if(c&&(a="none"===b.css(c,"display")),a){var e=b.get(".mc-list",d.containerEl);e&&(a="none"===b.css(e,"display"))}}return b[(a?"add":"remove")+"Class"](d.containerEl,i),a},window.CartPlugin&&window.CartPlugin.on("addToCartSuccess",function(){var a=e.getNum("amount");e.setNum("amount",a+1)}),TB.Global.miniCart.on("numChange",function(){var a=e.getNum("amount");e.getNum("amount")>0&&d.loginEl&&(b.remove(d.loginEl),b.addClass(d.rootEl,".mc-root-extend")),0>a?b.hide(d.amountEl):(b.html(d.amountEl,a),b.show(d.amountEl))}),e.on("cartDataLoaded",function(){var a=e.getNum("amount"),b="2.0"===TB.Global.version?!isNaN(TB.Global.util.getTag()):!0;!e.isLogin&&0==a||e.isLogin&&!b?d.renderLoginBtn():d.renderRoot(),d.checkHover()}),e.initAmount();var j;c.on([d.rootEl,d.hoverEl],"click",function(b){d.checkHover(),e._OFF||e.isTurnOff()?(d.popupMsg({html:'<p class="mc-notice"><a target="_blank" href="'+e.prom_URL+'">\u70b9\u51fb\u67e5\u770b\u8d2d\u7269\u8f66\u4e2d\u7684\u5b9d\u8d1d</a></p>'}),b.stopPropagation()):j||a.use("tbc/mini-cart/0.0.20/plugin/list",function(a,b){j=!0,b.on("showCartList",function(){e.makePoint("http://gm.mmstat.com/tbcart.6.2"),d.showCartList(),d.checkHover()}),b.on("hideCartList",function(){e.makePoint("http://gm.mmstat.com/tbcart.6.2"),d.hideCartList(),d.checkHover()}),b.on("makePoint",function(a){e.makePoint(a.url)}),b.on("showMsg",function(a){d.popupMsg(a),d.checkHover()}),b.init()})}),c.on(d.containerEl,"click",function(b){if(a.one(b.target).hasClass("J_MakePoint")){var c=a.one(b.target).attr("data-point-url");c&&c.match(/^http:\/\//)&&c&&e.makePoint(c)}}),d.checkHover(),c.on(d.containerEl,"mouseenter",function(){f&&clearTimeout(f),f=setTimeout(function(){d.checkHover()&&a.use("anim",function(a,b){b(d.hoverEl,{height:14},.3).run()})},200)}),c.on(d.containerEl,"mouseleave",function(){f&&clearTimeout(f),f=setTimeout(function(){d.checkHover()&&a.use("anim",function(a,b){b(d.hoverEl,{height:4},.3).run()})},200)}),e.isLogin&&d.initUMPP(),a.log("[MiniCart] inited.")}},renderLoginBtn:function(){var d=this;d.loginEl=b.create('<a href="#" class="mc-login-btn" title="\u767b\u5f55"></a>'),b.removeClass(d.rootEl,".mc-root-extend"),b.hide(d.amountEl),b.prepend(d.loginEl,d.rootEl),c.on(d.loginEl,"click",function(c){c.stopPropagation(),a.use("tbc/mini-login/1.4.0/",function(a,c){c.show(function(){e.isLogin=!0,b.remove(d.loginEl),b.addClass(d.rootEl,".mc-root-extend"),b.show(d.amountEl),e.asyncGetMiniCartCount(),d.initUMPP(),d.checkHover()})})})},renderRoot:function(){var a=this,c=e.getNum("amount");c>=0&&50>c?(b.html(a.amountEl,c),b.show(a.amountEl)):b.hide(a.amountEl),a.promMsgSlide&&(b.remove("#J_mc_msg_slide"),a.promMsgSlide.stop(),a.promMsgSlide=null),(e.getNum("promotionCount")>0||e.getNum("quailtyTenseCount")>0)&&a.renderPromMsgSlide(),a.toggleAutoSuggest()},renderPromMsgSlide:function(){var d=this,f='<div id="J_mc_msg_slide" class="mc-info"><ul class="tab-content mc_msg_list">',g=e.getNum("promotionCount"),h=e.getNum("quailtyTenseCount");g>0&&(f+='<li class="tab-pannel"><a class="mc-prom-info J_MakePoint" target="_blank" href="'+e.prom_URL+'" data-point-url="http://gm.mmstat.com/tbcart.6.4">\u964d\u4ef7\u5546\u54c1<em class="mc-prom-count">'+g+"</em></a></li>"),h>0&&(f+='<li class="tab-pannel"><a class="mc-prom-info J_MakePoint" target="_blank" href="'+e.stock_URL+'" data-point-url="http://gm.mmstat.com/tbcart.6.5">\u5e93\u5b58\u7d27\u5f20<em class="mc-stock-count">'+h+"</em></a></li>"),f+="</ul></div>",b.html(d.activityAreaEl,f),a.use("gallery/slide/1.1/index",function(a,f){d.promMsgSlide=new f("J_mc_msg_slide",{autoSlide:!0,effect:"vSlide",timeout:3e3,speed:700,hoverStop:!0});var g=b.query("a.mc-prom-info",d.activityAreaEl);c.on(g,"click",function(b){b.stopPropagation();var c=b.target;a.one(c).hasClass("mc-prom-info")||(c=a.one(c).parent(".mc-prom-info"));var d=a.one(c).attr("data-point-url");e.makePoint(d)})})},toggleAutoSuggest:function(){var a=e.getNum("amount"),b=e.getNum("promotionCount"),c=e.getNum("quailtyTenseCount"),d=new Date,f=d.getMonth(),g=d.getDate();5>=a&&!b&&!c&&!e.autoSuggest&&11===f&&g>1&&13>g?this.showAutoSuggest():(a>5||b||c)&&e.autoSuggest&&this.hideAutoSuggest()},showAutoSuggest:function(){var c=this;e.autoSuggest=!0,c.autoSuggestEl?b.show(c.autoSuggestEl):(c.autoSuggestEl=b.create('<div class="mc-auto-suggest"><a class="J_MakePoint" data-point-url="http://gm.mmstat.com/tbcart.6.11" href= '+e.cart_URL+' target="_blank" title="\u81ea\u52a8\u8d2d\u7269\u8f66\u5e2e\u4f60\u626b\u8d27">\u81ea\u52a8\u8d2d\u7269\u8f66\u5e2e\u4f60\u626b\u8d27</a></div>'),b.append(c.autoSuggestEl,c.activityAreaEl)),a.use("swf",function(a,d){var f=b.create('<a class="mc-auto-cart-icon" href="'+e.cart_URL+'"></a>');b.prepend(f,c.containerEl),c.swf=new d({src:"http://gtms01.alicdn.com/tps/i1/T1fOo.FX0XXXXtxVjX.swf",attrs:{width:280,height:50,wmode:"transparent"},params:{flashVars:{x:1},wmode:"transparent"},render:f}),setTimeout(function(){c.swf&&(c.swf.destroy(),c.swf=null)},1e4)})},hideAutoSuggest:function(){e.autoSuggest=!1,b.hide(this.autoSuggestEl);var a=b.get(".mc-auto-cart-icon",this.containerEl);a&&(self.swf&&(self.swf.destroy(),self.swf=null),b.remove(a))},showCartList:function(){var a=this;b.hide(a.activityAreaEl),b.addClass(a.rootEl,"mc-root-fold"),e.autoSuggest&&a.hideAutoSuggest(),b.query(".mc-msg",a.containerEl)&&b.remove(".mc-msg",a.containerEl),a.cartLink?b.show(a.cartLink):(a.cartLink=b.create('<a class="mc-cart-link J_MakePoint" data-point-url="http://gm.mmstat.com/tbcart.6.3" href="'+e.cart_URL+'" target="_blank" title="\u53bb\u8d2d\u7269\u8f66\u7ed3\u7b97">\u53bb\u8d2d\u7269\u8f66\u7ed3\u7b97</a>'),b.append(a.cartLink,a.rootEl))},hideCartList:function(){b.hide(this.cartLink),e.isLogin&&(b.show(this.activityAreaEl),this.renderRoot(),b.removeClass(this.rootEl,"mc-root-fold"))},initUMPP:function(){var b=this;a.use("gallery/storage/1.1/index",function(a,c){var d=!1;b.storage=new c,b.storage.get({k:"cart/msg/2",success:function(a){if(a){d=!0;var c=a.split(",").length;b.popupMsg({html:'<p class="mc-notice"><a class="J_MakePoint" target="_blank" href="'+e.prom_URL+'" data-point-url="http://gm.mmstat.com/tbcart.6.13">\u53c8\u6709<em>'+c+"</em>\u4ef6\u5b9d\u8d1d\u6709\u4f18\u60e0</a></p>"})}}}),b.storage.get({k:"cart/msg/4",success:function(a){if(a){d=!0;var c=a.split(",").length;b.popupMsg({html:'<p class="mc-notice"><a class="J_MakePoint" target="_blank" href="'+e.stock_URL+'" data-point-url="http://gm.mmstat.com/tbcart.6.13">\u53c8\u6709<em>'+c+"</em>\u4ef6\u5b9d\u8d1d\u5e93\u5b58\u7d27\u5f20</a></p>"})}}}),d||e.getTMSMsg(function(a){""!==a.text&&b.popupMsg({html:'<p class="mc-notice"><a class="J_MakePoint" target="_blank" href="'+a.href+'" data-point-url="http://gm.mmstat.com/tbcart.6.13">'+a.text+"</a></p>",time:3e4})})});var c=0,d=1e3;setTimeout(function(){var e=arguments.callee;a.TBC&&a.TBC.umpp?a.TBC.umpp.register("1070",function(a){b.showNewPromMsg(a.content)}):c++<5&&setTimeout(function(){e()},d)},d)},showNewPromMsg:function(b){var c=this,d=b.split(":"),f=d[0],g=d[1];f&&g&&c.storage.get({k:"cart/msg/"+f,success:function(b){var d=b?b.split(","):[];a.inArray(g,d)||(d.push(g),c.storage.set({k:"cart/msg/"+f,v:d.join(",")})),e.makePoint("http://gm.mmstat.com/tbcart.6.14");var h;2==f?(h='<p class="mc-notice"><a class="J_MakePoint" target="_blank" href="'+e.prom_URL+'" data-point-url="http://gm.mmstat.com/tbcart.6.13" >\u53c8\u6709<em>'+d.length+"</em>\u4ef6\u5b9d\u8d1d\u6709\u4f18\u60e0</p></a>",c.popupMsg({html:h})):4==f&&(h='<p class="mc-notice"><a class="J_MakePoint" target="_blank" href="'+e.stock_URL+'" data-point-url="http://gm.mmstat.com/tbcart.6.13">\u53c8\u6709<em>'+d.length+"</em>\u4ef6\u5b9d\u8d1d\u5e93\u5b58\u7d27\u5f20</p></a>",c.popupMsg({html:h}))}})},popupMsg:function(a){b.remove(".mc-msg","#J_miniCartPlugin");var c=b.get(".mc-auto-cart-icon","#J_miniCartPlugin");c&&(self.swf&&(self.swf.destroy(),self.swf=null),b.remove(c));var d='<div class="mc-msg">';d+=a.html?a.html:'<p class="mc-notice">'+a.msg+"</p>",d+="</div>";var e=b.create(d);b.prepend(e,this.containerEl),this.checkHover(),setTimeout(function(){b.remove(e)},a.time?a.time:5e3)}}),g},{requires:["dom","event","cookie","tbc/mini-cart/0.0.20/mods/cart","tbc/mini-cart/0.0.20/index.css"]});