/*! search-suggest 2013-08-29 */
KISSY.add("tbc/search-suggest/1.0.14/plugin/utils",function(a,b){function c(a){return d?d:(c.superclass.constructor.call(this,a||{}),d=this,void 0)}var d;return a.extend(c,b,{pluginInitializer:function(a){var b=this;b.set("caller",a)},getCookie:function(b){var c=window;if(c.userCookie&&!a.isUndefined(c.userCookie[b]))return c.userCookie[b];if(c.SRP_COOKIES||(c.SRP_COOKIES={})&&a.isUndefined(SRP_COOKIES[b])){var d=document.cookie.match("(?:^|;)\\s*"+b+"=([^;]*)");SRP_COOKIES[b]=d&&d[1]?decodeURIComponent(d[1]):""}return SRP_COOKIES[b]},fireEvent:function(a,b){var c=document;if(c.createEvent){var d=c.createEvent("MouseEvents");d.initEvent(b,!0,!1),a.dispatchEvent(d)}else c.createEventObject&&a.fireEvent("on"+b)}},{ATTRS:{pluginId:{value:"utils"}}}),c},{requires:["base"]}),KISSY.add("tbc/search-suggest/1.0.14/plugin/cloud",function(a,b,c){function d(a){d.superclass.constructor.call(this,a||{})}return a.extend(d,b,{pluginInitializer:function(b){var c,d,e=this,f=b.comboBox;e.isNotFirstRender=[],e.count=0,e.set("caller",b),e.initKeyEvent(),f.on("beforeShow",function(){if(e.isShowFirstItem){var a=d.get("children");d.set("highlightedItem",a[0])}}),b.on("afterCollapsedChange",function(f){f.newVal||(b.detach("afterCollapsedChange",arguments.callee),d=b.get("menu"),c=d.get("el"),d.on("afterHighlightedChange",e.menuHighlightEvent,e),c.delegate("mouseenter mouseleave",".search-menuitem",e.menuitemEvent,e),c.delegate("mousemove",".search-wrap-cloud",function(a){e.mouseStart=[a.clientX,a.clientY]}),c.delegate("mousemove",".search-menuitem",function(b){var c=a.one(b.target);e.mouseTarget=c.parent(".search-menuitem")}),c.delegate("mouseleave mouseenter",".cloud-footer",function(b){"mouseleave"===b.type?(e.isOnCloud=!1,a.one(".cloud-footer").hide(),c.all(".search-menuitem").removeClass("search-menuitem-hover")):(e.isOnCloud=!0,e.count<1&&e.mouseTarget&&e.mouseTarget.addClass("search-menuitem-hover"))}))})},menuHighlightEvent:function(b){var c=this,d=b.target,e=d.get("el");if(b.newVal)if(c.isOnTimeout===!0&&c.isVertical===!0)c.isOnTimeout&&e.removeClass("search-menuitem-hover"),c.count<2&&c.mouseTarget&&c.mouseTarget.addClass("search-menuitem-hover");else{if(!e.hasClass("search-menuitem"))return;var f,g,h=e.one(".search-wrap-cloud");if(h)f=h.one(".item-wrapper").attr("data-index"),g=a.one("#J_CloudList"+f),g&&(g.siblings().hide(),g.show(),a.one(".cloud-footer").show(),c.setPadding(e,g),c.isFirstShow||(c.isFirstShow=!0,c._sendStat()));else{var i=a.one(".cloud-footer");i&&i.hide()}}},menuitemEvent:function(b){var d=this,e=b.currentTarget,f=c.query(".item-wrapper",e)[0],g=a.one(".cloud-footer"),h=b.relatedTarget,i=b;if(f&&g){var j,k=f.getAttribute("data-index"),l=a.one("#J_CloudList"+k);if("mouseleave"===b.type&&h){var m=d._checkMouseMove({evt:b,node:g});d.isVertical=m,a.DOM.contains(".cloud-footer",h)||(m?(++d.count,!d.isOnTimeout,d.isOnTimeout=!0,window.clearTimeout(d.onCloudT),d.onCloudT=window.setTimeout(function(){d.count=0;var b=i.relatedTarget,e=c.get(b,".search-wrap-cloud");if(d.isOnTimeout=!1,d.isOnCloud||e){if(d.mouseTarget){var f,h=d.mouseTarget.one(".item-wrapper"),k=h.attr("data-index");if(!k)return;if(f=a.one("#J_CloudList"+k),j=h.parent(".search-menuitem"),!f||!j)return;f.show(),f.siblings().hide(),g.show(),j.siblings().removeClass("search-menuitem-hover"),j.addClass("search-menuitem-hover")}}else l.hide(),g.hide(),d.mouseTarget&&(d.mouseTarget.addClass("search-menuitem-hover"),d.mouseTarget.siblings().removeClass("search-menuitem-hover"))},500)):(l&&(l.hide(),g.hide(),a.one(e).parent().removeClass("search-menuitem-hover")),window.clearTimeout(d.onCloudT)))}else!d.isOnTimeout&&l&&(g.show(),l.siblings().hide(),l.show())}},_sendStat:function(){var a=this.get("caller"),b=a.getPlugin("stat"),c="f_stats_show=magic:1",d=a.get("sugConfig").sourceUrl,e="";d&&d.match(/bucketid=\w+/)&&(e=d.match(/bucketid=(\w+)/)[1],c+=";bts:"+e),b&&b.send(c,!0)},getPadding:function(b,c){var d=30,e=a.one(".search-menu"),f=e.offset().top,g=b.offset().top,h=g-f,i=e.height(),j=c.height(),k=h-d,l=i-j-k-10;return k>0?l>=0?k:k-=35*Math.round(-l/35):void 0},initKeyEvent:function(){var a=this,b=a.get("caller"),c=b.comboBox;c.on("beforeKeyDown",function(b){var c=b.event;if(13===c.keyCode){var d=a.isShowMagic()||a.isShowItem();return d&&(d.click(),c.halt()),!1}a.directionEvent(c)})},isShowMagic:function(){var b,d,e,f=a.all(".cloud-list");return f.each(function(a){"none"!==c.css(a,"display")&&(b=a)}),b?(d=c.query(".cloud-link-wrap-hover")[0],d&&(e=c.query("a",d)[0]),e):void 0},isShowItem:function(){return c.get(".search-menuitem-hover")},directionEvent:function(b){var c,d,e,f,g,h=this;switch(b.keyCode){case 39:case 37:if(c=h.get("caller").get("menu").get("activeItem"),!c)return!0;if(d=c.get("el").one(".item-wrapper"),!d)return!0;if(e=d.attr("data-index"),!e)return!0;if(f=a.one("#J_CloudList"+e),!f)return!0;g=h.getHighLightItem(f,!!(b.keyCode-37)),g.node&&g.node.addClass("cloud-link-wrap-hover"),g.last&&g.last.removeClass("cloud-link-wrap-hover");break;default:var i=a.one(".cloud-link-wrap-hover");i&&i.removeClass("cloud-link-wrap-hover")}},getHighLightItem:function(a,b){var c=a.one(".cloud-link-wrap-hover"),d=b?"next":"prev";return c?{node:c[d](),last:c}:{node:a.one(".cloud-link").parent(),last:null}},setPadding:function(a,b){var c=b.one(".inner-wrap"),d=this.getPadding(a,c);d&&c.css("paddingTop",d)},_checkMouseMove:function(a){var b=this,c=b.mouseStart;if(!c)return!1;var d=a.node,e=a.evt,f=d.offset(),g=d.height(),h=f.top,i=h+g;return e.clientX-c[0],f.left-c[0],.7*(h-c[1]),.7*(i-c[1]),(e.clientX-c[0])/(e.clientY-c[1]),!1},checkRender:function(a){var b=a.comboBox,c=a.query,d=b.get("dataSource"),e=d.extraData[c],f=a.resultArr;return""!==c&&e?{extra:e,query:c,results:f}:!1},isAutoShow:function(b){return!!(a.isArray(b)&&b.length>0&&b[0].list)},renderPlugin:function(){var b=this,c=b.get("caller"),d=b.checkRender(c);if(!d)return!1;var e,f,g,h,i,j,k,l="",m=d.extra,n=d.results,o=d.query;b.isFirstShow=!1,e=a.clone(m.magic);for(var p=b.isAutoShow(c.resultArr),q=0,r=n.length-1;r>=q;q++){f=n[q];for(var s in e){if(i=f.content,g=i.match(/data-index='(\w+)'/),h=i.match(/data-key='([\S\s]+?)'/),!g||!g[1])break;g=g[1]-0,h&&h[1]&&(h=h[1]),g===e[s].index&&(1===g&&(k=!0),j=e[s].list,l+=b._renderHTML({result:f,data:j,query:o,index:g,key:h,auto:p}))}}var t={tmpl:'<div class="cloud-box">'+l+"</div>",type:"cloud"};if(p&&k?(t.css={display:"block"},b.isShowFirstItem=!0):b.isShowFirstItem=!1,a.UA.ie<7){var u=c.resultArr.length;t.css={height:26*u}}c.__footer=t,c._addExtraEvent()},_renderHTML:function(b){var c,d,e=this,f={},g=b.result,h=b.data,i=b.query,j=b.index,k=e.get("tmpl"),l=b.key,m=b.auto&&1===j?"style='display:block'":"";return c=g.content,g.content="<div class='search-wrap-cloud' data-key='"+l+"'>"+c+"</div>",f.title=d=c.replace(/<(\s|\S)+?>/g,""),f.list=e._dealData({arr:h,isFirstRender:!e.isNotFirstRender[i],data:{title:d,wq:i,index:j}}),f.autoAttr=m,f.index=j,a.substitute(k,f)},_dealData:function(b){var c,d=this.get("liTmpl"),e=b.arr,f=b.data,g="";e.length>10&&e.splice(10),b.isFirstRender&&(e[0]&&(e[0]="<b>"+e[0]+"</b>"),e[1]&&(e[1]="<b>"+e[1]+"</b>")),this.sort(e);for(var h=0,i=e.length-1;i>=h;h++)f.tag=c=e[h].replace(/<b>(\S+)\<\/b>/,function(a,b){return b}),f.index2=h+1,f.query=f.title+" "+c,f.text=e[h],g+=a.substitute(d,f);return g},sort:function(a){Array.prototype.sort.call(a,function(){return Math.random()>.5?-1:1})}},{ATTRS:{pluginId:{value:"cloud"},limit:{value:3,setter:function(b){return a.isNumber(b)?b:void 0}},tmpl:{value:'<div id="J_CloudList{index}" class="cloud-list" {autoAttr} ><div class="inner-wrap"><h3>{title}</h3><ul>{list}</ul></div></div>'},liTmpl:{value:'<li><a target="_self" href="http://s.taobao.com/search?q={query}&wq={wq}&source=suggest&suggest=magic_{index}_{index2}&tag={tag}"  class="cloud-link"><span>{text}</span></a></li>'}}}),d},{requires:["base","dom","event","cookie","./utils"]});