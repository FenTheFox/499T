/*! search-suggest 2013-08-29 */
KISSY.add("tbc/search-suggest/1.0.14/plugin/storage",function(a,b,c){function d(a){return e||(d.superclass.constructor.call(this,a||{}),e=this,e.initialize()),e}var e;return d.ATTRS={src:{value:"http://a.tbcdn.cn/apps/tbskip/public/flashStorage.swf"},bridge:{value:null},hasInit:{value:!1}},a.extend(d,b,{initialize:function(a){a=a||{};var b=this;b._addFlash(a.appendTo),b.hasInit=!0},_addFlash:function(a){var b,c=this,d=document,e=d.createElement("div"),f=c.get("src"),g="";e.id="storagetool",e.style.height=0,e.style.overflow="hidden",g+='<object id="J_StorageObj" name="J_StorageObj" ',g+='classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="1" height="1" ',g+='codebase="http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab">',g+='<param name="movie" value="'+f+'" />',g+='<param name="allowScriptAccess" value="always" />',g+='<embed name="J_StorageEmbed" src="'+f+'" width="1" height="1" ',g+='allowScriptAccess="always" type="application/x-shockwave-flash" ',g+='pluginspage="http://www.adobe.com/go/getflashplayer">',g+="</embed></object>",a=a||d.body,a.appendChild(e),e.innerHTML=g,-1!==navigator.appVersion.indexOf("MSIE")?(e.style.zoom=1,e.style.filter="alpha(opacity=10)",b=window.J_StorageObj):(e.style.opacity=.1,b=d.J_StorageEmbed),c.set("bridge",b)},save:function(a,b,d){var e=this,f=e.get("bridge");if(d===c&&(d=200),0!==d)try{f.save(a,b)}catch(g){setTimeout(function(){e.save(a,b,d-1)},0)}},read:function(a,b,d){var e,f=this,g=f.get("bridge");if(d===c&&(d=200),0===d)return b&&b.onFailure&&b.onFailure(),void 0;try{return e=g.read(a),b&&b.onSuccess(e),e}catch(h){setTimeout(function(){f.read(a,b,d-1)},0)}}}),d},{requires:["base"]}),KISSY.add("tbc/search-suggest/1.0.14/plugin/local-query",function(a,b,c,d){function e(a){e.superclass.constructor.call(this,a||{}),this.initialize()}var f=null,g="localQuery";return a.extend(e,b,{initialize:function(){var a=this,b=a.get("name"),c=a.get("tab"),d=a.get("user");"item"===c&&(c="baobei"),a.storageKey=g+b+c+d,a._getStorage()},checkFlash:function(a){this.storage.read(a)},_setKey:function(a){var b=this,c=a.name||b.get("name"),d=a.tab||b.get("tab"),e=a.user||b.get("user");"item"===d&&(d="baobei"),b.storageKey=g+c+d+e,b.set("tab",d),b.set("name",c),b.set("user",e),f=null},_save:function(b,c){if(!b.match(/<>'"/)&&!c.match(/<>'"/)){var d=this._getDatalist(),e=encodeURI(b),f={key:e,value:encodeURI(c),time:a.now()};this._deleteItemByValue(d,e),d.unshift(f)}},_deleteItemByValue:function(a,b){for(var c,d=null,e=0;e<a.length;e++)c=a[e].key,c==b&&(d=a.splice(e,1),e--)},_query:function(b){var c,d,e=this._getDatalist(),f=[];return b?(b=encodeURI(b),a.each(e,function(a){c=a.key,d=a.value,(0===c.indexOf(b)||0===d.indexOf(b))&&f.push(a)}),this._distinctByValue(f)):this._distinctByValue(e)},_distinctByValue:function(a){for(var b,c=[],d=0,e=a.length;e>d;d++)b=a[d],b.value.match(/%3C|%3E|[<>'"]/g)||!this._hasItemOfValue(c,b.value)&&c.push(b);return c},_hasItemOfValue:function(a,b){for(var c=!1,d=a.length-1;d>=0;d--)a[d].value===b&&(c=!0);return c},_cleanBefore:function(a){for(var b,c=this._getDatalist(),d=0,e=c.length-1;e>=0;e--)if(b=c[e],b.time>a){d=e+1;break}c.length=d},_getDatalist:function(){return f=this.storage.read()||[]},_getStorage:function(){var a=this.get("storageType");switch(a){case"flashStorage":this.storage=this._initFlashStorage();break;default:this.storage=!1}},_initFlashStorage:function(){var b=this;return{save:function(){return(new c).save(b.storageKey,a.JSON.stringify(f))},read:function(e){var f=(new c).read(b.storageKey,e);return f?a.JSON.parse(f):d}}},destructor:function(){f=null,g=null},save:function(a,b){if(""!=b){var c=this._save(a,b);return this.storage.save(),c}},query:function(a){return this._query(a)},deleteItem:function(a){var b=this._getDatalist();this._deleteItemByValue(b,encodeURI(a)),this.storage.save()},clearByDay:function(b){var c=a.now()-1e3*3600*24*b;this._cleanBefore(c),this.storage.save()},hasHistory:function(){return this._getDatalist().length>0?!0:!1}},{ATTRS:{name:{value:"default",setter:function(a){return a}},user:{value:"",setter:function(b){return a.fromUnicode(b)}},maxLength:{value:500},storageType:{value:"flashStorage",setter:function(a){return a},getter:function(a){return a}}}}),e},{requires:["base","./storage"]}),KISSY.add("tbc/search-suggest/1.0.14/plugin/stat",function(a,b,c,d,e){function f(a){f.superclass.constructor.call(this,a||{})}return a.extend(f,b,{pluginInitializer:function(a){var b=this,c=b.get("stat");b.set("caller",a),a.on("beforeSubmit",function(a){var c=a.isInitSearch;b.setStat(c)}),c&&(b.sendTongji(),b.bindSearchTrace())},bindSearchTrace:function(){var a=this;d.delegate("body","click","a",a.initSearchTrace,a)},initSearchTrace:function(a){var b=this,c=a.currentTarget,d=c.getAttribute("trace"),e=c.getAttribute("href");if(d)switch(d){case"relatedSearch":b.saveQuery();break;case"auction":var f=b.stat;f&&c.setAttribute("href",e+"&initiative_new=1")}},sendTongji:function(){var a,b=this,c=b.getStatInst();c.checkFlash({onSuccess:function(){a=c.query("stat")[0],a&&a.value&&(b.stat=a.value,b.send("f_stats_show="+a.value,!0))}})},setStat:function(a,b){var c=this,d=c.get("caller"),e=d.query,f=c.saveQuery(e,a);f&&c.send("lf_aclog=null-null-null-null-0&stats_click="+f,b)},getStatInst:function(){var a=this,b=a.get("caller"),c=b.get("sugConfig"),d=c.tab||"",f=new e({name:"stat",tab:d});return f},saveQuery:function(a,b){var c,d,e=this.getStatInst();return b&&a?(c=encodeURI(a),d="initiative_new:1;q:"+c,e.save("stat",d)):e.deleteItem("stat"),d},send:function(a,b){var c,d;b?(c="/tongji",d="H51884970"):(c="/search",d="H51884969"),(window.goldlog_queue||(window.goldlog_queue=[])).push({action:"goldlog.record",arguments:[c,"",a,d]})},renderPlugin:function(){}},{ATTRS:{pluginId:{value:"stat"}}}),f},{requires:["base","cookie","event","./local-query"]});