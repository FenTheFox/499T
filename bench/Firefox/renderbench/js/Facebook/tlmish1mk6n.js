/*!CK:1504671629!*//*1413168686,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["dVNlB"]); }

__d("MercuryActionStatus",[],function(a,b,c,d,e,f){e.exports={UNSENT:0,SUCCESS:1,UNCONFIRMED:3,FAILED_UNKNOWN_REASON:4,UNABLE_TO_CONFIRM:5,RESENT:6,RESENDING:7,ERROR:10};},null);
__d("MercuryAPIArgsSource",[],function(a,b,c,d,e,f){e.exports={CHAT:"chat",JEWEL:"jewel",MERCURY:"mercury",WEBMESSENGER:"web_messenger"};},null);
__d("MercuryAttachmentContentType",[],function(a,b,c,d,e,f){e.exports={PHOTO:"attach:image",VIDEO:"attach:video",MUSIC:"attach:music",VOICE:"attach:voice",TEXT:"attach:text",MSWORD:"attach:ms:word",MSXLS:"attach:ms:xls",MSPPT:"attach:ms:ppt",ORION:"attach:orion",SHOERACK_INVITATION:"attach:shoerackinvite",UNKNOWN:"attach:unknown"};},null);
__d("MercuryAttachmentType",[],function(a,b,c,d,e,f){e.exports={ERROR:"error",FILE:"file",PHOTO:"photo",STICKER:"sticker",SHARE:"share",UNKNOWN:"unknown",VIDEO:"video"};},null);
__d("MercuryErrorType",[],function(a,b,c,d,e,f){e.exports={SERVER:1,TRANSPORT:2,TIMEOUT:3};},null);
__d("MercuryGenericConstants",[],function(a,b,c,d,e,f){e.exports={PENDING_THREAD_ID:"pending:pending",MAX_THREAD_NAME_LENGTH:"250"};},null);
__d("MercuryGlobalActionType",[],function(a,b,c,d,e,f){e.exports={MARK_ALL_READ:"mga-type:mark-all-read"};},null);
__d("MercuryLogMessageType",[],function(a,b,c,d,e,f){e.exports={SUBSCRIBE:"log:subscribe",UNSUBSCRIBE:"log:unsubscribe",VIDEO_CALL:"log:video-call",PHONE_CALL:"log:phone-call",THREAD_NAME:"log:thread-name",THREAD_IMAGE:"log:thread-image",SERVER_ERROR:"log:error-msg",LIVE_LISTEN:"log:live-listen",WALLPAPER:"log:wallpaper"};},null);
__d("MercuryPayloadSource",[],function(a,b,c,d,e,f){e.exports={UNKNOWN:"unknown",CLIENT_CHANNEL_MESSAGE:"client_channel_message",CLIENT_SEND_MESSAGE:"client_send_message",CLIENT_CHANGE_ARCHIVED_STATUS:"client_change-archived_status",CLIENT_CHANGE_FOLDER:"client_change_folder",CLIENT_CHANGE_MUTE_SETTINGS:"client_change_mute_settings",CLIENT_CHANGE_READ_STATUS:"client_change_read_status",CLIENT_CLEAR_CHAT:"client_clear_chat",CLIENT_DELETE_MESSAGES:"client_delete_messages",CLIENT_DELETE_THREAD:"client_delete_thread",CLIENT_HANDLE_ERROR:"client_handle_error",SERVER_INITIAL_DATA:"server_initial_data",SERVER_SEND_MESSAGE:"server_send_message",SERVER_CONFIRM_MESSAGES:"server_confirm_messages",SERVER_CHANGE_ARCHIVED_STATUS:"server_change_archived_status",SERVER_CHANGE_READ_STATUS:"server_change_read_status",SERVER_MARK_FOLDER_READ:"server_mark_folder_read",SERVER_MARK_SEEN:"server_mark_seen",SERVER_FETCH_THREAD_INFO:"server_fetch_thread_info",SERVER_FETCH_THREADLIST_INFO:"server_fetch_threadlist_info",SERVER_THREAD_SYNC:"server_thread_sync",SERVER_TAB_PRESENCE:"server_tab_presence",SERVER_UNREAD_THREADS:"server_unread_threads",SERVER_SEARCH:"server_search"};},null);
__d("MercurySendMessageFields",[],function(a,b,c,d,e,f){e.exports={AUTO_RETRY_CNT:"auto_retry_cnt",MANUAL_RETRY_CNT:"manual_retry_cnt"};},null);
__d("MercurySourceType",[],function(a,b,c,d,e,f){e.exports={CHAT_ORCA:"source:chat:orca",CHAT_IPHONE:"source:chat:iphone",CHAT_JABBER:"source:chat:jabber",CHAT_MEEBO:"source:chat:meebo",CHAT_WEB:"source:chat:web",CHAT_TEST:"source:chat:test",CHAT:"source:chat",EMAIL:"source:email",GIGABOXX_API:"source:gigaboxx:api",GIGABOXX_BLAST:"source:gigaboxx:blast",GIGABOXX_EMAIL_REPLY:"source:gigaboxx:emailreply",GIGABOXX_MOBILE:"source:gigaboxx:mobile",GIGABOXX_WAP:"source:gigaboxx:wap",GIGABOXX_WEB:"source:gigaboxx:web",LEIA:"source:leia",SHARE_DIALOG:"source:share:dialog",SEND_PLUGIN:"source:sendplugin",SMS:"source:sms",TEST:"source:test",TITAN_WAP:"source:titan:wap",TITAN_M_BASIC:"source:titan:m_basic",TITAN_M_JAPAN:"source:titan:m_japan",TITAN_M_MINI:"source:titan:m_mini",TITAN_M_TOUCH:"source:titan:m_touch",TITAN_M_APP:"source:titan:m_app",TITAN_M_TABLET:"source:titan:m_tablet",TITAN_M_ZERO:"source:titan:m_zero",TITAN_M_TALK:"source:titan:m_talk",TITAN_WEB:"source:titan:web",TITAN_FACEWEB_ANDROID:"source:titan:faceweb_android",TITAN_FACEWEB_BUFFY:"source:titan:faceweb_buffy",TITAN_FACEWEB_IPAD:"source:titan:faceweb_ipad",TITAN_FACEWEB_IPHONE:"source:titan:faceweb_iphone",TITAN_FACEWEB_UNKNOWN:"source:titan:faceweb_unknown",TITAN_API:"source:titan:api",TITAN_API_MOBILE:"source:titan:api_mobile",TITAN_ORCA:"source:titan:orca",TITAN_EMAIL_REPLY:"source:titan:emailreply",MOBILE:"source:mobile",UNKNOWN:"source:unknown",WEB:"source:web",HELPCENTER:"source:helpcenter",NEW_SHARE_DIALOG:"source:share:dialog:new",PAID_PROMOTION:"source:paid_promotion",BUFFY_SMS:"source:buffy:sms",WEBRTC_MOBILE:"source:webrtc:mobile"};},null);
__d("MercuryThreadMode",[],function(a,b,c,d,e,f){e.exports={EMAIL_ORIGINATED:1,TITAN_ORIGINATED:2,OBJECT_ORIGINATED:3};},null);
__d("MessagingTag",[],function(a,b,c,d,e,f){e.exports={GROUPS:"groups",UNREAD:"unread",ACTION_ARCHIVED:"action:archived",INBOX:"inbox",OTHER:"other",EVENT:"event",SENT:"sent",SMS_MUTE:"sms_mute",SPAM:"spam",UPDATES:"broadcasts_inbox",BCC:"header:bcc",FILTERED_CONTENT:"filtered_content",ARCHIVED:"archived",EMAIL:"email",VOICEMAIL:"voicemail",SPAM_SPOOFING:"spam:spoofing",SPOOF_WARNING:"MTA:spoof_warning",SMS_TAG_ROOT:"SMSShortcode:",APP_ID_ROOT:"app_id:",DOMAIN_AUTH_PASS:"MTA:dmarc:pass",DOMAIN_AUTH_FAIL:"MTA:dmarc:fail",MTA_SYSTEM_MESSAGE:"MTA:system_message",EMAIL_MESSAGE:"source:email"};},null);
__d("ReportState",["ErrorUtils","invariant"],function(a,b,c,d,e,f,g,h){var i={};function j(l,m){h(!i[l]);i[l]=m;}function k(){var l={};Object.keys(i).forEach(function(m){try{l[m]=i[m]();}catch(n){g.reportError('ReportState: callback threw an error.');}});return l;}e.exports={registerCallback:j,getState:k};},null);
__d("MercurySingletonMixin",["CurrentUser"],function(a,b,c,d,e,f,g){var h={_getInstances:function(){if(!this._instances)this._instances={};return this._instances;},get:function(){return this.getForFBID(g.getID());},getForFBID:function(i){var j=this._getInstances();if(!j[i])j[i]=new this(i);return j[i];}};e.exports=h;},null);
__d("MercuryMessageClientState",[],function(a,b,c,d,e,f){var g={DO_NOT_SEND_TO_SERVER:'do_not_send_to_server',SEND_TO_SERVER:'send_to_server'};e.exports=g;},null);
__d("MercuryMessageIDs",["KeyedCallbackManager"],function(a,b,c,d,e,f,g){var h=new g(),i={getServerIDs:function(j,k){var l=j.filter(function(n){return n.indexOf('mail.projektitan.com')!==-1;}),m=function(n){var o=j.map(function(p){return n[p]?n[p]:p;});k(o);};return h.executeOrEnqueue(l,m);},addServerID:function(j,k){h.setResource(j,k);}};e.exports=i;},null);
__d("MercuryIDs",[],function(a,b,c,d,e,f){var g={isValid:function(h){if(!h||typeof h!=='string')return false;return (/^\w{3,12}:/.test(h));},isValidThreadID:function(h){if(!g.isValid(h))return false;var i=g.tokenize(h);switch(i.type){case 'user':case 'group':case 'thread':case 'root':case 'pending':return true;default:return false;}},tokenize:function(h){if(!this.isValid(h))throw ("bad_id_format "+h);var i=h.indexOf(':');return {type:h.substr(0,i),value:h.substr(i+1)};},getUserIDFromParticipantID:function(h){if(!this.isValid(h))throw ("bad_id_format "+h);var i=g.tokenize(h),j=i.type,k=i.value;if(j!='fbid')return null;return k;},getParticipantIDFromUserID:function(h){if(isNaN(h))throw ("Not a user ID: "+h);return 'fbid:'+h;},getUserIDFromThreadID:function(h){if(!this.isCanonical(h))return null;return this.tokenize(h).value;},getThreadIDFromUserID:function(h){return 'user:'+h;},getThreadIDFromParticipantID:function(h){var i=this.getUserIDFromParticipantID(h);return i?this.getThreadIDFromUserID(i):null;},isCanonical:function(h){return this.isValid(h)&&this.tokenize(h).type==='user';},isMultichat:function(h){return this.isValid(h)&&this.tokenize(h).type!=='user';}};e.exports=g;},null);
__d("MercuryAssert",["MercuryIDs"],function(a,b,c,d,e,f,g){e.exports={isParticipantID:function(h){if(!g.isValid(h))throw ("bad_participant_id "+h);},allParticipantIDs:function(h){h.forEach(this.isParticipantID);},isUserParticipantID:function(h){var i=g.tokenize(h);if(i.type!='fbid')throw ("bad_user_id "+h);},isEmailParticipantID:function(h){var i=g.tokenize(h);if(i.type!='email')throw ("bad_email_id "+h);},allThreadID:function(h){h.forEach(this.isThreadID);},isThreadID:function(h){if(!g.isValid(h))throw ("bad_thread_id "+h);}};},null);
__d("MercurySendAttemptLogger",["Banzai","BanzaiLogger","MercuryAttachmentType","MercurySendMessageFields"],function(a,b,c,d,e,f,g,h,i,j){var k=h.create({retry:true}),l=g.isEnabled('mercury_send_attempt_logging'),m=function(o){if(!o.has_attachment)return null;if(o.sticker_id)return i.STICKER;if((o.image_ids&&o.image_ids.length)||(o.photo_fbids&&o.photo_fbids.length))return i.PHOTO;if(o.raw_attachments&&o.raw_attachments.length)return i.FILE;if(o.content_attachment)return i.SHARE;return i.UNKNOWN;},n={log:function(o){if(!l)return;var p={message_id:o.message_id,timestamp_client:o.timestamp,attempt_num:o[j.MANUAL_RETRY_CNT],first_attachment_type:m(o),source:o.source,auto_retry_cnt:o[j.AUTO_RETRY_CNT]};k.log('MercurySendAttemptLoggerConfig',p);}};e.exports=n;},null);
__d("MercurySendErrorLogger",["Banzai","BanzaiLogger"],function(a,b,c,d,e,f,g,h){var i=h.create({retry:true}),j=g.isEnabled('mercury_send_attempt_logging'),k={log:function(l){if(!j)return;var m={message_id:l.message_id,timestamp_client:Date.now(),error_type:l.error_data.type,error_code:l.error_data.code,error_description:l.error_data.description,is_transient:l.error_data.is_transient};i.log('MercurySendErrorLoggerConfig',m);}};e.exports=k;},null);
__d("MessagingReliabilityLogger",["PresenceUtil","MercuryServerDispatcher","MessagingReliabilityLoggerInitialData","isEmpty","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k){var l='/ajax/mercury/client_reliability.php',m=60000;function n(t,u){var v={app:i.app,categories:JSON.stringify(t)};if(!j(u))v.extra=JSON.stringify(u);return v;}function o(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=0;t[u][v]+=w;}function p(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=[];for(var x=0;x<w.length;++x)t[u][v].push(w[x]);}function q(t,u){if((t&&!t.categories)||(u&&!u.categories))return;var v=t?JSON.parse(t.categories):{},w=t&&t.extra?JSON.parse(t.extra):{},x=JSON.parse(u.categories),y=u.extra?JSON.parse(u.extra):{};for(var z in x){var aa=x[z],ba=y[z];for(var ca in aa){o(v,z,ca,aa[ca]);if(ba!==undefined){var da=ba[ca];if(da!==undefined)p(w,z,ca,da);}}}return n(v,w);}var r={};r[l]={mode:h.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR,batch_function:q};h.registerEndpoints(r);var s={addEntry:function(t,u,v){if(!i.enabled)return;var w={};o(w,t,u,1);var x={};if(v!==undefined)p(x,t,u,[v]);h.trySend(l,n(w,x));}};(function t(){s.addEntry('page_event','active',g.getSessionID());k(t,m);})();e.exports=s;},null);
__d("MercuryThreadInformer",["ArbiterMixin","LogHistory","MercuryAssert","MercuryLoggingHelper","MercurySingletonMixin","copyProperties","mapObject","mixin"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){'use strict';var o=h.getInstance('mercury_informer'),p=n(g);for(var q in p)if(p.hasOwnProperty(q))s[q]=p[q];var r=p===null?null:p.prototype;s.prototype=Object.create(r);s.prototype.constructor=s;s.__superConstructor__=p;function s(u){this.$MercuryThreadInformer0=u;this.$MercuryThreadInformer1={};this.$MercuryThreadInformer2={};this.$MercuryThreadInformer3={};this.$MercuryThreadInformer4=false;this.$MercuryThreadInformer5=false;this.$MercuryThreadInformer6=false;this.$MercuryThreadInformer7={};this.$MercuryThreadInformer8={};this.$MercuryThreadInformer9={};this.$MercuryThreadInformera=0;}s.prototype.updatedThread=function(u){this.$MercuryThreadInformer2[u]=true;this.$MercuryThreadInformerb();};s.prototype.deletedThread=function(u){this.$MercuryThreadInformer1[u]=true;this.$MercuryThreadInformerb();};s.prototype.updatedThreadlist=function(){this.$MercuryThreadInformer4=true;this.$MercuryThreadInformerb();};s.prototype.updatedUnseenState=function(){this.$MercuryThreadInformer5=true;this.$MercuryThreadInformerb();};s.prototype.updatedUnreadState=function(){this.$MercuryThreadInformer6=true;this.$MercuryThreadInformerb();};s.prototype.changedThreadReadState=function(u,v,w){if(!this.$MercuryThreadInformer3[u]||this.$MercuryThreadInformer3[u].timestamp<w)this.$MercuryThreadInformer3[u]={mark_as_read:v,timestamp:w};this.$MercuryThreadInformerb();};s.prototype.receivedMessage=function(u){i.isThreadID(u.thread_id);var v=u.thread_id;if(!this.$MercuryThreadInformer7[v])this.$MercuryThreadInformer7[v]=[];this.$MercuryThreadInformer7[v].push(u);this.updatedThread(v);};s.prototype.reorderedMessages=function(u,v){this.$MercuryThreadInformer8[u]={source:v};this.$MercuryThreadInformerb();};s.prototype.updatedMessage=function(u,v,w){if(!this.$MercuryThreadInformer9[u])this.$MercuryThreadInformer9[u]={};this.$MercuryThreadInformer9[u][v]={source:w};this.updatedThread(u);};s.prototype.synchronizeInforms=function(u){this.$MercuryThreadInformera++;try{u();}catch(v){throw v;}finally{this.$MercuryThreadInformera--;this.$MercuryThreadInformerb();}};s.prototype.listen=function(u,v){return this.subscribe('threads-updated',function(w,x){if(x[u])v(u);});};s.prototype.$MercuryThreadInformerb=function(){if(!this.$MercuryThreadInformera){var u=this.$MercuryThreadInformer1,v=this.$MercuryThreadInformer2,w=this.$MercuryThreadInformer3,x=this.$MercuryThreadInformer4,y=this.$MercuryThreadInformer5,z=this.$MercuryThreadInformer6,aa=this.$MercuryThreadInformer7,ba=this.$MercuryThreadInformer8,ca=this.$MercuryThreadInformer9;this.$MercuryThreadInformer1={};this.$MercuryThreadInformer2={};this.$MercuryThreadInformer3={};this.$MercuryThreadInformer4=false;this.$MercuryThreadInformer5=false;this.$MercuryThreadInformer6=false;this.$MercuryThreadInformer7={};this.$MercuryThreadInformer8={};this.$MercuryThreadInformer9={};var da=Object.keys(v);if(da.length||x)this.$MercuryThreadInformerc('threadlist-updated',da);if(da.length)this.$MercuryThreadInformerc('threads-updated',v);for(var ea in w){this.$MercuryThreadInformerc('thread-read-changed',w);break;}for(ea in u){this.$MercuryThreadInformerc('threads-deleted',u);break;}if(y)this.$MercuryThreadInformerc('unseen-updated',null);if(z)this.$MercuryThreadInformerc('unread-updated',null);for(ea in aa){this.$MercuryThreadInformerc('messages-received',aa);break;}for(ea in ba){this.$MercuryThreadInformerc('messages-reordered',ba);break;}for(ea in ca){this.$MercuryThreadInformerc('messages-updated',ca);break;}}};s.prototype.$MercuryThreadInformerc=function(u,v){t(u,v);this.inform(u,v);};function t(u,v){var w=v;if(u=='messages-received')w=m(w,function(x){return x.map(function(y){return j.obfuscateMessage(y);});});o.debug(u,w);}l(s,k);e.exports=s;},null);
__d("MercuryServerRequests",["Arbiter","ArbiterMixin","AsyncResponse","BanzaiLogger","ChannelConstants","CurrentUser","KeyedCallbackManager","LogHistory","MercuryActionStatus","MercuryActionTypeConstants","MercuryAPIArgsSource","MercuryAssert","MercuryErrorType","MercuryGenericConstants","MercuryGlobalActionType","MercuryIDs","MercuryLoggingHelper","MercuryLogMessageType","MercuryMessageClientState","MercuryPayloadSource","MercurySendAttemptLogger","MercurySendErrorLogger","MercuryServerRequestsConfig","MercurySingletonMixin","MercurySourceType","MercuryThreadlistConstants","MercuryMessageIDs","MessagingConfig","MessagingReliabilityLogger","MessagingTag","MercuryServerDispatcher","MercurySendMessageFields","MercuryThreadInformer","copyProperties","createObjectFrom","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa){"use strict";var qa=n.getInstance('mercury_server'),ra=q.MERCURY;function sa(dc,ec){if(ec)dc._lastActionTimestamp=Math.max(dc._lastActionTimestamp,ec);}function ta(dc,ec){var fc=ec.thread_fbid;if(ec.canonical_fbid)fc=ec.canonical_fbid;var gc=dc._FBIDToClientIDs.getResource(fc);if(!gc){if(ec.canonical_fbid){gc='user:'+ec.canonical_fbid;}else if(ec.root_message_threading_id)gc='root:'+ec.root_message_threading_id;gc=gc||'thread:'+fc;if(fc)fc=fc.toString();va(dc,fc,gc);if(ec.thread_id)ua(dc,ec.thread_id,gc);}ec.thread_id=gc;}function ua(dc,ec,fc){dc._serverToClientIDs.setResource(ec,fc);dc._clientToServerIDs.setResource(fc,ec);dc._newlyAddedClientIDs[ec]=fc;}function va(dc,ec,fc){dc._clientIDToFBIDs.setResource(fc,ec);dc._FBIDToClientIDs.setResource(ec,fc);dc._newlyAddedClientIDs[ec]=fc;}function wa(dc,ec,fc){var gc=dc._clientIDToFBIDs.executeOrEnqueue(ec,fc),hc=dc._clientIDToFBIDs.getUnavailableResources(gc),ic=v.tokenize(ec);if(hc.length&&ic.type!='root')dc.fetchThreadData(hc);}function xa(dc,ec){return dc._clientIDToFBIDs.getResource(ec);}function ya(dc,ec){return !!dc._FBIDToClientIDs.getResource(ec);}function za(dc,ec){var fc=dc._serverToClientIDs.getResource(ec);if(typeof fc=='undefined')qa.warn('no_client_thread_id',{server_id:ec});return fc;}function ab(dc,ec){var fc=dc._FBIDToClientIDs.getResource(ec);if(typeof fc=='undefined')qa.warn('no_client_thread_id',{thread_fbid:ec});return fc;}function bb(dc,ec,fc){dc._FBIDToClientIDs.executeOrEnqueue(ec,fc);dc.ensureThreadIsFetched(ec);}function cb(dc,ec,fc){if(ec.action_type!=p.SEND_MESSAGE)return;var gc=ec.thread_fbid;if(ec.other_user_fbid)gc=ec.other_user_fbid;var hc=ec.client_thread_id;if(!hc)hc=ab(dc,gc);var ic=null;if(hc)ic=v.tokenize(hc).type;eb(dc,ec,fc==='success');if(ec.status===o.ERROR){ba.log(ec);}else ia.addEntry('send_'+ic,fc,gc+','+ec.message_id);}function db(dc){return dc.getError()?'_'+dc.getError():'';}function eb(dc,ec,fc){if(Math.floor(Math.random()*20)===0)if(ec.client_message_id in dc._sentMessagesTimestamp){var gc=dc._sentMessagesTimestamp[ec.client_message_id],hc=Date.now()-gc,ic=ec.client_thread_id;if(!ic)ic=ab(dc,ec.thread_fbid);j.log('WebMessagingLatencyLoggerConfig',{has_attachment:ec.attachments&&ec.attachments.length>0,latency:hc,is_canonical:!v.isMultichat(ic),send_successful:fc,source:'client'});}}function fb(dc,ec){var fc=null;switch(ec.status){case o.SUCCESS:fc='success';break;case o.FAILED_UNKNOWN_REASON:fc='confirmed_error';break;case o.UNABLE_TO_CONFIRM:fc='confirm_error';break;default:return;}cb(dc,ec,fc);}function gb(dc,ec){(ec.threads||[]).forEach(function(nc){ta(dc,nc);delete dc._fetchingThreads[nc.thread_id];var oc=xa(dc,nc.thread_id);delete dc._fetchingThreads[oc];sa(dc,nc.timestamp);});(ec.ordered_threadlists||[]).forEach(function(nc){var oc=nc.thread_fbids||[];oc=oc.concat(nc.other_user_fbids||[]);nc.thread_ids=oc.map(ab.bind(null,dc));});ec.actions=ec.actions||[];ec.actions.forEach(function(nc){fb(dc,nc);var oc=nc.thread_fbid;if(nc.other_user_fbid)oc=nc.other_user_fbid;if(nc.status&&nc.status!=o.SUCCESS&&!oc){nc.thread_id=nc.client_thread_id;return;}if(nc.action_type==p.SEND_MESSAGE&&nc.client_thread_id&&nc.client_thread_id!=t.PENDING_THREAD_ID&&oc)va(dc,oc.toString(),nc.client_thread_id);var pc=nc.thread_id;if(oc){nc.thread_id=ya(dc,oc)?ab(dc,oc):null;}else if(nc.client_thread_id)nc.thread_id=nc.client_thread_id;if(!nc.thread_id)nc.server_thread_id=pc;sa(dc,nc.timestamp);});if(ec.end_of_history){var fc=[];for(var gc=0;gc<ec.end_of_history.length;gc++){var hc=ec.end_of_history[gc];if(hc.type=='user'){fc.push('user:'+hc.fbid);}else if(hc.type=='thread'&&ya(dc,hc.fbid))fc.push(ab(dc,hc.fbid));}ec.end_of_history=fc;}if(ec.roger){var ic={};for(var jc in ec.roger){var kc=dc._serverToClientIDs.getResource(jc);if(kc){var lc=ec.roger[jc];ic[kc]={};for(var mc in lc)ic[kc]['fbid:'+mc]=lc[mc];}}ec.roger=ic;}}function hb(dc){if(dc._pendingUpdates&&dc._pendingUpdates.length){var ec=dc._pendingUpdates[0];dc._pendingUpdates=dc._pendingUpdates.slice(1);dc.handleUpdate(ec);}}function ib(dc,ec){var fc=na({},dc),gc;if(ec.threads){if(!fc.threads)fc.threads={};for(gc in ec.threads)fc.threads[gc]=Object.keys(oa((fc.threads[gc]||[]).concat(ec.threads[gc])));}if(ec.messages){if(!fc.messages)fc.messages={};for(gc in ec.messages){if(!fc.messages[gc])fc.messages[gc]={};for(var hc in ec.messages[gc])if(fc.messages[gc][hc]){fc.messages[gc][hc]=lb(fc.messages[gc][hc],ec.messages[gc][hc]);}else fc.messages[gc][hc]=ec.messages[gc][hc];}}fc.client=dc.client||ec.client;return fc;}function jb(dc,ec){var fc=na(oa(dc.folders,true),oa(ec.folders,true)),gc=dc.client||ec.client;return {folders:Object.keys(fc),client:gc};}function kb(dc,ec){for(var fc in ec)if(dc[fc]&&typeof dc[fc]==='object'){dc[fc]=lb(dc[fc],ec[fc]);}else if(ec[fc]&&typeof ec[fc]==='object'){var gc={};na(gc,ec[fc]);dc[fc]=gc;}return dc;}function lb(dc,ec){var fc=dc.offset<ec.offset?dc.offset:ec.offset,gc=dc.offset+dc.limit,hc=ec.offset+ec.limit,ic=(gc>hc)?gc:hc,jc=ic-fc;return {offset:fc,limit:jc};}function mb(dc,ec){var fc=dc.client||ec.client,gc={ids:{},client:fc};na(gc.ids,dc.ids);na(gc.ids,ec.ids);return gc;}function nb(dc,ec){var fc={},gc,hc=dc.client||ec.client;delete dc.client;delete ec.client;for(gc in dc)na(fc,oa(dc[gc],gc));for(gc in ec)na(fc,oa(ec[gc],gc));var ic={client:hc};for(var jc in fc){gc=fc[jc];if(!ic[gc])ic[gc]=[];ic[gc].push(jc);}return ic;}function ob(dc,ec){var fc=dc.client||ec.client,gc=oa(dc.ids,true),hc=oa(ec.ids,true),ic=na(gc,hc);return {ids:Object.keys(ic),client:fc};}function pb(dc){this._fbid=dc;this._lastActionTimestamp=0;this._serverToClientIDs=new m();this._clientToServerIDs=new m();this._FBIDToClientIDs=new m();this._clientIDToFBIDs=new m();this._pendingUpdates=[];this._fetchingThreads={};this._newlyAddedClientIDs={};this._sentMessagesTimestamp={};bc(this);}na(pb.prototype,h,{getServerThreadID:function(dc,ec){r.isThreadID(dc);wa(this,dc,ec);},getThreadFBID:function(dc,ec){r.isThreadID(dc);wa(this,dc,ec);},getClientThreadID:function(dc,ec){bb(this,dc,ec);},getClientThreadIDNow:function(dc){return ab(this,dc);},getServerThreadIDNow:function(dc){return xa(this,dc);},getClientThreadIDForPermalinks:function(dc){return za(this,dc);},convertThreadIDIfAvailable:function(dc){var ec=this._FBIDToClientIDs.getResource(dc);if(ec===undefined){return dc;}else return ec;},isUser:function(dc){return dc<2.2e+09||(dc>=1e+14&&dc<=100099999989999)||(dc>=8.9e+13&&dc<=89999999999999);},canLinkExternally:function(dc){r.isThreadID(dc);var ec=v.tokenize(dc);return (ec.type=='user')||!!xa(this,dc);},fetchThreadlistInfo:function(dc,ec,fc,gc,hc){fc=fc||ja.INBOX;hc=hc||ra;var ic=gc?ka.IMMEDIATE:null,jc={client:hc};jc[fc]={offset:dc,limit:ec,filter:gc};cc(this,'/ajax/mercury/threadlist_info.php',jc,ic);},fetchUnseenThreadIDs:function(dc,ec){ec=ec||ra;this.fetchThreadlistInfo(fa.RECENT_THREAD_OFFSET,fa.JEWEL_THREAD_COUNT,dc,null,ec);},fetchUnreadThreadIDs:function(dc,ec){ec=ec||ra;cc(this,'/ajax/mercury/unread_threads.php',{folders:[dc],client:ec});},fetchMissedMessages:function(dc,ec){ec=ec||ra;var fc={last_action_timestamp:this._lastActionTimestamp,folders:dc,client:ec};fc.last_action_timestamp=this._lastActionTimestamp;cc(this,'/ajax/mercury/thread_sync.php',fc);},fetchThreadData:function(dc,ec){ec=ec||ra;r.allThreadID(dc);var fc={threads:{},client:ec},gc=[],hc=[];dc.forEach(function(jc){if(this._fetchingThreads[jc])return;this._fetchingThreads[jc]=true;var kc=xa(this,jc),lc=v.tokenize(jc);if(lc.type=='user'){gc.push(lc.value);fc.threads.user_ids=gc;}else if(lc.type=='thread'){if(kc){hc.push(kc);}else hc.push(lc.value);fc.threads.thread_fbids=hc;}else if(lc.type!='root'&&lc.type!='pending')throw new Error('Unknown thread type',lc);}.bind(this));this.inform("fetch-thread-data",fc);for(var ic in fc.threads){cc(this,'/ajax/mercury/thread_info.php',fc);break;}},ensureThreadIsFetched:function(dc,ec){ec=ec||ra;if(!this._FBIDToClientIDs.getResource(dc)&&!this._fetchingThreads[dc]){this._fetchingThreads[dc]=true;cc(this,'/ajax/mercury/thread_info.php',{threads:{thread_fbids:[dc]},client:ec});}},fetchThreadMessages:function(dc,ec,fc,gc,hc){r.isThreadID(dc);hc=hc||ra;var ic,jc,kc=v.tokenize(dc),lc=xa(this,dc),mc=false;if(lc){ic=lc;jc=(kc.type=='user')?'user_ids':'thread_fbids';}else{ic=kc.value;switch(kc.type){case 'user':jc='user_ids';mc=true;break;case 'thread':jc='thread_fbids';break;}}var nc={messages:{},threads:{},client:hc};if(jc){nc.messages[jc]={};nc.messages[jc][ic]={offset:ec,limit:fc};if(mc)nc.threads[jc]=[ic];cc(this,'/ajax/mercury/thread_info.php',nc,gc);}else wa(this,dc,function(oc){nc.messages.thread_fbids={};nc.messages.thread_fbids[oc]={offset:ec,limit:fc};cc(this,'/ajax/mercury/thread_info.php',nc,gc);}.bind(this));},handleThreadInfoError:function(dc){var ec=dc.getRequest().getData(),fc=[];if(ec.messages){for(var gc in ec.messages.thread_fbids)fc.push(qb(ab(this,gc)));for(var hc in ec.messages.user_ids)fc.push(qb('user:'+hc));for(var ic in ec.messages.group_ids)fc.push(qb('group:'+ic));}if(fc.length)this.handleUpdate({actions:fc,from_client:true,payload_source:z.CLIENT_CHANNEL_MESSAGE});if(ec.threads&&(ec.threads.user_ids||ec.threads.group_ids||ec.threads.thread_ids)){var jc=5,kc=true;if(!ec.retry_count){ec.retry_count=0;if(ec.messages)delete ec.messages;}else if(ec.retry_count>=jc){kc=false;(ec.threads.thread_ids||[]).forEach(function(mc){if(mc in this._fetchingThreads)delete this._fetchingThreads[mc];}.bind(this));}if(kc){var lc=ec.retry_count*1000;pa(function(){qa.log('retry_thread',ec);cc(this,'/ajax/mercury/thread_info.php',ec);}.bind(this),lc);ec.retry_count++;}}},markFolderAsRead:function(dc){cc(this,'/ajax/mercury/mark_folder_as_read.php',{folder:dc});var ec=[{action_type:u.MARK_ALL_READ,action_id:null,folder:dc}];this.handleUpdate({global_actions:ec,from_client:true,payload_source:z.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatus:function(dc,ec){r.isThreadID(dc);wa(this,dc,function(fc){var gc={ids:{}};gc.ids[fc]=ec;cc(this,'/ajax/mercury/change_read_status.php',gc);}.bind(this));},changeThreadArchivedStatus:function(dc,ec){r.isThreadID(dc);wa(this,dc,function(fc){var gc={ids:{}};gc.ids[fc]=ec;cc(this,'/ajax/mercury/change_archived_status.php',gc);}.bind(this));},changeThreadFolder:function(dc,ec){r.isThreadID(dc);wa(this,dc,function(fc){var gc={};gc[ec]=[fc];cc(this,'/ajax/mercury/move_thread.php',gc);}.bind(this));},changeMutingOnThread:function(dc,ec){r.isThreadID(dc);wa(this,dc,function(fc){cc(this,'/ajax/mercury/change_mute_thread.php',{thread_fbid:fc,mute_settings:ec,payload_source:ra});}.bind(this));},markThreadSpam:function(dc){r.isThreadID(dc);wa(this,dc,function(ec){cc(this,'/ajax/mercury/mark_spam.php',{id:ec});}.bind(this));},markMessagesSpam:function(dc,ec){ga.getServerIDs(ec||[],function(gc){cc(this,'/ajax/mercury/mark_spam_messages.php',{message_ids:gc});}.bind(this));var fc={action_type:p.DELETE_MESSAGES,action_id:null,thread_id:dc,message_ids:ec};this.handleUpdate({actions:[fc],from_client:true,payload_source:z.CLIENT_DELETE_MESSAGES});},unmarkThreadSpam:function(dc){r.isThreadID(dc);wa(this,dc,function(ec){cc(this,'/ajax/mercury/unmark_spam.php',{id:ec});}.bind(this));},deleteThread:function(dc){r.isThreadID(dc);wa(this,dc,function(ec){var fc={ids:[ec]};cc(this,'/ajax/mercury/delete_thread.php',fc);}.bind(this));},deleteMessages:function(dc,ec,fc){ga.getServerIDs(ec||[],function(hc){cc(this,'/ajax/mercury/delete_messages.php',{message_ids:hc});}.bind(this));var gc;if(fc){gc={action_type:p.DELETE_THREAD,action_id:null,thread_id:dc};}else gc={action_type:p.DELETE_MESSAGES,action_id:null,thread_id:dc,message_ids:ec};this.handleUpdate({actions:[gc],from_client:true,payload_source:z.CLIENT_DELETE_MESSAGES});},clearChat:function(dc,ec,fc){r.isThreadID(dc);cc(this,'/ajax/chat/settings.php',{clear_history_id:ec});var gc=[{action_type:p.CLEAR_CHAT,action_id:null,thread_id:dc,clear_time:fc}];this.handleUpdate({actions:gc,from_client:true,payload_source:z.CLIENT_CLEAR_CHAT});},sendNewMessage:function(dc,ec){ec=ec||ra;if(!dc.client_state||dc.client_state==y.SEND_TO_SERVER)ga.getServerIDs(dc.forward_message_ids||[],function(gc){var hc=dc.thread_id,ic=v.tokenize(dc.thread_id),jc=ic.type,kc=na({},dc);kc.forward_message_ids=gc;if((jc=='root'&&ic.value==kc.message_id)||(jc=='user')||(hc==t.PENDING_THREAD_ID)){kc.client_thread_id=kc.thread_id;kc.thread_id=null;this._sendNewMessageToServer(kc,ec);}else wa(this,kc.thread_id,function(lc){ic=v.tokenize(kc.thread_id);if(ic.type=='user'){kc.other_user_fbid=ic.values;}else kc.thread_fbid=lc;kc.thread_id=null;this._sendNewMessageToServer(kc);}.bind(this));}.bind(this));if(dc.thread_id!=t.PENDING_THREAD_ID){var fc={actions:[na({},dc)],from_client:true,payload_source:z.CLIENT_SEND_MESSAGE};this.handleUpdate(fc);}},_sendNewMessageToServer:function(dc,ec){g.inform(k.ATTEMPT_RECONNECT);ec=ec||ra;this._sentMessagesTimestamp[dc.message_id]=Date.now();cc(this,'/ajax/mercury/send_messages.php',{message_batch:[dc],client:ec});setTimeout(function(){aa.log(dc);},0);},requestMessageConfirmation:function(dc,ec){ec=ec||ra;var fc={},gc={};for(var hc in dc){var ic=xa(this,hc);if(ic){fc[ic]=dc[hc];}else{var jc=dc[hc];for(var kc=0;kc<jc.length;kc++)gc[jc[kc]]=hc;}}var lc=Object.keys(fc),mc=Object.keys(gc);if(lc.length||mc.length)cc(this,'/ajax/mercury/confirm_messages.php',{thread_message_map:fc,local_messages:gc,client:ec});},handleMessageConfirmError:function(dc){var ec=dc.getRequest().getData().thread_message_map,fc=dc.getRequest().getData().local_messages;if(!ec&&!fc)return;var gc=[];for(var hc in ec){var ic=ec[hc];ic.forEach(function(lc){gc.push({action_type:p.SEND_MESSAGE,client_message_id:lc,message_id:lc,client_thread_id:null,thread_fbid:hc,status:o.UNABLE_TO_CONFIRM});});}for(var jc in fc){var kc=fc[jc];gc.push({action_type:p.SEND_MESSAGE,client_message_id:jc,message_id:jc,client_thread_id:kc,thread_fbid:null,status:o.UNABLE_TO_CONFIRM});}if(gc.length)this.handleUpdate({actions:gc,payload_source:z.CLIENT_HANDLE_ERROR});},markSeen:function(){var dc=this._lastActionTimestamp;cc(this,'/ajax/mercury/mark_seen.php',{seen_timestamp:dc});},handleRoger:function(dc){var ec=dc.tid?this._serverToClientIDs.getResource(dc.tid):('user:'+dc.reader);if(ec){var fc={};fc[ec]={};fc[ec]['fbid:'+dc.reader]=dc.time;this.inform('update-roger',fc);}},handleUpdateWaitForThread:function(dc,ec,fc){fc=fc||ra;var gc=this._FBIDToClientIDs.getResource(ec);if(gc){this.handleUpdate(dc);return;}this._FBIDToClientIDs.executeOrEnqueue(ec,function(){this._pendingUpdates.push(dc);}.bind(this));if(!this._fetchingThreads[ec]){this._fetchingThreads[ec]=true;var hc={threads:{thread_fbids:[ec]},client:fc};if(this.isUser(ec))hc={threads:{user_ids:[ec]},client:fc};cc(this,'/ajax/mercury/thread_info.php',hc);}},handleUpdate:function(dc){var ec=[];if(dc&&dc.threads)for(var fc=0;fc<dc.threads.length;fc++){if(!dc.threads[fc].snippet_attachments)continue;for(var gc=0;gc<dc.threads[fc].snippet_attachments.length;gc++)if(dc.threads[fc].snippet_attachments[gc].share_xhp){ec.push({i:fc,j:gc,xhp:dc.threads[fc].snippet_attachments[gc].share_xhp});dc.threads[fc].snippet_attachments[gc].share_xhp="HTMLDivElement not shown: object contains circular "+"reference, which was breaking JSON.stringify. "+"Look at MercuryServerRequests.handleUpdate";}}var hc={actions:[],threads:[]};if(dc){if(dc.actions)for(var ic=0;ic<dc.actions.length;ic++){var jc=na({},dc.actions[ic]);w.obfuscateAction(jc);hc.actions.push(jc);}if(dc.threads)for(ic=0;ic<dc.threads.length;ic++){var kc=na({},dc.threads[ic]);w.obfuscateThread(kc);hc.threads.push(kc);}}var lc=na({},dc,hc);qa.debug('update:'+dc.payload_source,{payload:lc,from_client:dc.from_client});for(var mc=0;mc<ec.length;mc++)dc.threads[ec[mc].i].snippet_attachments[ec[mc].j].share_xhp=ec[mc].xhp;for(mc in dc){ma.getForFBID(this._fbid).synchronizeInforms(function(){if(!dc.from_client){gb(this,dc);this.inform('payload-preprocessed',dc);}this.inform('update-thread-ids',this._newlyAddedClientIDs);this._newlyAddedClientIDs={};this.inform('update-participants',dc);this.inform('update-threads',dc);this.inform('update-unread',dc);this.inform('update-threadlist',dc);this.inform('update-messages',dc);this.inform('update-unseen',dc);this.inform('update-typing-state',dc);this.inform('update-roger',dc.roger);this.inform('model-update-completed',null);hb(this);}.bind(this));break;}},_handleSendMessageErrorCommon:function(dc,ec,fc,gc){qa.debug('handle_send_message_error_common',{reliability_error_status:fc,request_error_status:ec});var hc=dc.getData(),ic=hc.message_batch,jc=ic.map(function(lc){var mc={action_type:p.SEND_MESSAGE,thread_fbid:lc.thread_fbid,client_message_id:lc.message_id,message_id:lc.message_id,client_thread_id:lc.client_thread_id,status:ec,error_data:gc};return mc;});jc.forEach(function(lc){cb(this,lc,fc);},this);var kc={actions:jc,payload_source:z.CLIENT_HANDLE_ERROR};this.handleUpdate(kc);},handleSendMessageError:function(dc){var ec=dc.getPayload(),fc=null,gc=null;if(ec&&ec.error_payload){fc=o.UNCONFIRMED;gc='send_error';}else{fc=o.ERROR;gc='request_error'+db(dc);}var hc=dc.error;if(hc===1404102)i.verboseErrorHandler(dc);var ic=/<.*>/.test(dc.getErrorDescription())?dc.getErrorSummary():dc.getErrorDescription();this._handleSendMessageErrorCommon(dc.getRequest(),fc,gc,{type:s.SERVER,code:dc.getError(),description:ic,is_transient:dc.isTransient()});},handleSendMessageTransportError:function(dc){this._handleSendMessageErrorCommon(dc.getRequest(),o.ERROR,'transport_error'+db(dc),{type:s.TRANSPORT,code:dc.getError(),is_transient:true});},_shouldRetryAfterTimeout:function(dc){var ec=dc.getData().message_batch;for(var fc=0;fc<ec.length;fc++){var gc=ec[fc],hc=gc[la.AUTO_RETRY_CNT];if(hc<ca.maxAutoRetries)return true;}return false;},handleSendMessageTimeout:function(dc){if(this._shouldRetryAfterTimeout(dc)){var ec=dc.getData();for(var fc=0;fc<ec.message_batch.length;fc++){var gc=ec.message_batch[fc],hc=na({},gc);hc[la.AUTO_RETRY_CNT]+=1;this._sendNewMessageToServer(hc);}}else this._handleSendMessageErrorCommon(dc,o.ERROR,'transport_timeout',{type:s.TIMEOUT,is_transient:true});},getLastActionTimestamp:function(){return this._lastActionTimestamp;}});na(pb,da);function qb(dc){return {action_type:p.LOG_MESSAGE,thread_id:dc,message_id:dc,timestamp:Date.now(),timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:ea.UNKNOWN,log_message_type:x.SERVER_ERROR,log_message_data:{}};}function rb(dc){var ec=dc.getData(),fc=ec.request_user_id?ec.request_user_id:l.getID();return pb.getForFBID(fc);}function sb(dc,ec){rb(ec).handleUpdate(dc);}function tb(dc,ec){var fc=dc.client||ec.client;return {client:fc,message_batch:dc.message_batch.concat(ec.message_batch)};}function ub(dc,ec){var fc={};na(fc,dc.ids);na(fc,ec.ids);var gc=dc.client||ec.client;return {ids:fc,client:gc};}function vb(dc,ec){return ec;}function wb(dc){var ec=rb(dc.getRequest());ec.handleThreadInfoError(dc);}function xb(dc){var ec=rb(dc.getRequest());ec.handleSendMessageError(dc);}function yb(dc){var ec=rb(dc.getRequest());ec.handleSendMessageTransportError(dc);}function zb(dc){var ec=rb(dc);ec.handleSendMessageTimeout(dc);}function ac(dc){var ec=rb(dc.getRequest());ec.handleMessageConfirmError(dc);}function bc(dc){ka.registerEndpoints({'/ajax/mercury/thread_sync.php':{request_user_id:dc._fbid,mode:ka.IDEMPOTENT,handler:sb},'/ajax/mercury/thread_info.php':{request_user_id:dc._fbid,mode:ka.BATCH_DEFERRED_MULTI,batch_function:ib,handler:sb,error_handler:wb},'/ajax/mercury/mark_folder_as_read.php':{request_user_id:dc._fbid,mode:ka.IMMEDIATE,handler:sb},'/ajax/mercury/change_read_status.php':{request_user_id:dc._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:ub,handler:sb},'/ajax/mercury/send_messages.php':{request_user_id:dc._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:tb,batch_size_limit:ha.SEND_BATCH_LIMIT,handler:sb,error_handler:xb,transport_error_handler:yb,timeout:ca.sendMessageTimeout,timeout_handler:zb,connection_retries:ha.SEND_CONNECTION_RETRIES},'/ajax/mercury/mark_seen.php':{request_user_id:dc._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:vb,handler:sb},'/ajax/mercury/confirm_messages.php':{request_user_id:dc._fbid,mode:ka.IMMEDIATE,handler:sb,error_handler:ac},'/ajax/mercury/threadlist_info.php':{request_user_id:dc._fbid,mode:ka.BATCH_SUCCESSIVE_UNIQUE,batch_function:kb,handler:sb},'/ajax/mercury/mark_spam.php':{request_user_id:dc._fbid,mode:ka.IMMEDIATE,handler:sb},'/ajax/mercury/mark_spam_messages.php':{request_user_id:dc._fbid,mode:ka.IMMEDIATE,handler:sb},'/ajax/mercury/unmark_spam.php':{request_user_id:dc._fbid,mode:ka.IMMEDIATE,handler:sb},'/ajax/mercury/unread_threads.php':{request_user_id:dc._fbid,mode:ka.BATCH_SUCCESSIVE_UNIQUE,batch_function:jb,handler:sb},'/ajax/chat/settings.php':{request_user_id:dc._fbid,mode:ka.IMMEDIATE},'/ajax/mercury/change_archived_status.php':{request_user_id:dc._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:mb,handler:sb},'/ajax/mercury/delete_thread.php':{request_user_id:dc._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:ob,handler:sb},'/ajax/mercury/delete_messages.php':{request_user_id:dc._fbid,mode:ka.IMMEDIATE,handler:sb},'/ajax/mercury/move_thread.php':{request_user_id:dc._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:nb,handler:sb},'/ajax/mercury/change_mute_thread.php':{request_user_id:dc._fbid,mode:ka.IMMEDIATE,handler:sb}});}function cc(dc,ec,fc,gc){ka.trySend(ec,fc,gc,dc._fbid);}e.exports=pb;},null);
__d("MercuryAttachment",["MercuryAttachmentContentType","MercuryAttachmentType","startsWith"],function(a,b,c,d,e,f,g,h,i){var j={getAttachIconClass:function(k){switch(k){case g.PHOTO:return 'MercuryPhotoIcon';case g.VIDEO:return 'MercuryVideoIcon';case g.MUSIC:return 'MercuryMusicIcon';case g.VOICE:return 'MercuryVoiceIcon';case g.TEXT:return 'MercuryTextIcon';case g.MSWORD:return 'MercuryMSWordIcon';case g.MSXLS:return 'MercuryMSXLSIcon';case g.MSPPT:return 'MercuryMSPPTIcon';}return 'MercuryDefaultIcon';},getAttachIconClassByMime:function(k){if(i(k,'image')){return 'MercuryPhotoIcon';}else if(i(k,'video')){return 'MercuryVideoIcon';}else if(i(k,'audio')){return 'MercuryMusicIcon';}else if(i(k,'text/plain')){return 'MercuryTextIcon';}else return 'MercuryDefaultIcon';},getAttachTypeByMime:function(k){if(i(k,'image')){return g.PHOTO;}else if(i(k,'video')){return g.VIDEO;}else if(i(k,'audio')){return g.MUSIC;}else if(i(k,'text/plain')){return g.TEXT;}else return g.UNKNOWN;},convertRaw:function(k){var l=[];for(var m=0;m<k.length;m++){var n=k[m];if(n.attach_type===h.PHOTO){l.push(n);}else if(n.filename){var o=j.getAttachTypeByMime(n.filetype),p={};p.attach_type=h.FILE;p.name=n.filename;p.icon_type=o;p.url='';l.push(p);}}return l;},get:function(k){var l=[];if(k.attachments){l=k.attachments;}else if(k.raw_attachments)l=this.convertRaw(k.raw_attachments);if(!(k.attachments&&k.attachments.length>0)&&k.preview_attachments&&k.preview_attachments.length>0)return l.concat(k.preview_attachments);return l;}};e.exports=j;},null);
__d("MercuryThreads",["KeyedCallbackManager","MercuryActionTypeConstants","MercuryAssert","MercuryAttachment","MercuryGlobalActionType","MercuryIDs","MercuryLogMessageType","MercuryPayloadSource","MercurySingletonMixin","MercuryThreadMode","MessagingTag","ReportState","MercuryServerRequests","MercuryThreadInformer","copyProperties","createObjectFrom","removeFromArray"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w){function x(ja,ka,la){var ma=v(ka.participants,true),na=l.getParticipantIDFromUserID(ja._fbid);la.forEach(function(oa){if(ma[oa]!==true){ka.participants.push(oa);if(oa===na)ka.is_subscribed=true;}});}function y(ja,ka,la){la.forEach(function(ma){w(ka.participants,ma);if(ma===l.getParticipantIDFromUserID(ja._fbid))ka.is_subscribed=false;});}function z(ja,ka){if(ja.participants[0]!=ka){w(ja.participants,ka);ja.participants.unshift(ka);}}function aa(ja,ka){var la=ka.body,ma=ka.subject,na='';if(ma){ma=ma.toLowerCase();if(la.slice(0,ma.length).toLowerCase()==ma){na=la;}else if(la){na=ma+' \u00B7 '+la;}else na=ma;}else na=la;ja.snippet=na;ja.snippet_has_attachment=ka.has_attachment;if(ka.raw_attachments&&ka.raw_attachments.length>0){var oa=j.convertRaw(ka.raw_attachments);ja.snippet_attachments=oa;}else ja.snippet_attachments=ka.attachments;ja.is_forwarded_snippet=!!ka.forward_count;ja.snippet_sender=ka.author;}function ba(ja,ka){var la=ja._threads.getAllResources();for(var ma in la){var na=la[ma];if(na.folder==ka){na.unread_count=0;ja._threads.setResource(ma,na);ja._threadInformer.updatedThread(ma);}}}function ca(ja,ka,la){if(!ka||ka.chat_clear_time===la)return false;ka.chat_clear_time=la;ja._threadInformer.reorderedMessages(ka.thread_id);return true;}function da(ja,ka,la,ma){if(la.timestamp)ja._threadInformer.changedThreadReadState(ka.thread_id,ma,la.timestamp);if(!ka||!ka.thread_id)return false;if(!ka.timestamp){ja._pendingReadStatusThreads[ka.thread_id]=true;return false;}var na=!ka.unread_count;if(ma==na)return false;ka.unread_count=ma?0:1;ja._threadInformer.updatedThread(ka.thread_id);return true;}function ea(ja,ka,la,ma){var na=la.action_type;if(na==h.USER_GENERATED_MESSAGE||na==h.LOG_MESSAGE){la.is_unread&&ka.unread_count++;ka.message_count++;ka.is_archived=false;}switch(na){case h.USER_GENERATED_MESSAGE:if(ka.last_read_timestamp>=la.timestamp)da(ja,ka,la,true);z(ka,la.author);break;case h.SEND_MESSAGE:var oa=la.log_message_type;if(oa==m.THREAD_IMAGE)ka.image_src=la.log_message_data.image?la.log_message_data.image.preview_url:null;ka.snippet_attachments=la.attachments;break;case h.LOG_MESSAGE:var oa=la.log_message_type;if(oa==m.SUBSCRIBE){x(ja,ka,la.log_message_data.added_participants);}else if(oa==m.UNSUBSCRIBE){y(ja,ka,la.log_message_data.removed_participants);}else if(oa==m.THREAD_IMAGE){if(!ma)ka.image_src=la.log_message_data.image?la.log_message_data.image.preview_url:null;}else if(oa==m.THREAD_NAME)ka.name=la.log_message_data.name;break;case h.CHANGE_READ_STATUS:var pa=da(ja,ka,la,la.mark_as_read);if(pa&&la.timestamp)ka.last_read_timestamp=la.timestamp;if(pa&&ma)ja._serverRequests.changeThreadReadStatus(ka.thread_id,la.mark_as_read);break;case h.CLEAR_CHAT:ca(ja,ka,la.clear_time);break;case h.CHANGE_ARCHIVED_STATUS:if(ka.is_archived!=la.archived){ka.is_archived=la.archived;ja._threadInformer.updatedThread(la.thread_id);}break;case h.CHANGE_FOLDER:if(ka.folder!=la.new_folder){ka.folder=la.new_folder;ja._threadInformer.updatedThread(la.thread_id);}break;case h.DELETE_MESSAGES:if(ma){ka.snippet='...';ka.snippet_has_attachment=false;ka.snippet_attachments=null;ka.snippet_sender=null;ka.is_forwarded_snippet=false;ja._threadInformer.updatedThread(la.thread_id);}else if(la.message_ids)ka.message_count=ka.message_count-la.message_ids.length;break;case h.CHANGE_MUTE_SETTINGS:if(la.mute_settings!==undefined){var qa=ja._fbid+'@facebook.com';if(ka.mute_settings){if(la.mute_settings){ka.mute_settings[qa]=la.mute_settings;}else delete ka.mute_settings[qa];ja._threadInformer.updatedThread(ka.thread_id);}}break;}}function fa(ja,ka){var la=l.tokenize(ka.thread_id),ma=ha(ja,ka.specific_to_list),na={thread_id:ka.thread_id,last_action_id:null,participants:ka.specific_to_list,name:null,snippet:ka.body,snippet_has_attachment:false,snippet_attachments:[],snippet_sender:ka.author,unread_count:0,message_count:0,image_src:null,timestamp_absolute:ka.timestamp_absolute,timestamp_relative:ka.timestamp_relative,timestamp:ka.timestamp,canonical_fbid:la.type==='user'?la.value:null,is_canonical_user:la.type==='user',is_canonical:ma,is_subscribed:true,root_message_threading_id:ka.message_id,folder:q.INBOX,is_archived:false,mode:p.TITAN_ORIGINATED};return na;}function ga(ja){this._fbid=ja;this._serverRequests=s.getForFBID(this._fbid);this._threadInformer=t.getForFBID(this._fbid);this._threads=new g();this._pendingReadStatusThreads={};ia(this);}u(ga.prototype,{getThreadMetaNow:function(ja){i.isThreadID(ja);return this._threads.getResource(ja);},getThreadMeta:function(ja,ka,la){var ma=function(na){ka(na[ja]);};return this.getMultiThreadMeta([ja],ma,la);},getMultiThreadMeta:function(ja,ka,la){i.allThreadID(ja);var ma=this._threads.executeOrEnqueue(ja,ka),na=this._threads.getUnavailableResources(ma);if(na.length){var oa=[];for(var pa=0;pa<na.length;pa++){var qa=na[pa],ra=l.tokenize(qa);if(ra.type=='user'){var sa=this._getCanonicalThreadToUser(ra.value,null,la,true);if(this.isEmptyLocalThread(sa.thread_id))oa.push(sa.thread_id);}else oa.push(qa);}if(oa.length)this._serverRequests.fetchThreadData(oa,la);}return ma;},unsubscribe:function(ja){this._threads.unsubscribe(ja);},updateThreads:function(ja){if(!ja||!ja.length)return;var ka={};ja.forEach(function(la){ka[la.thread_id]=la;});this._threads.addResourcesAndExecute(ka);},updateMetadataByActions:function(ja,ka){if(!ja||!ja.length)return;var la={},ma={},na={};for(var oa=0;oa<ja.length;oa++){var pa=ja[oa];if(pa.is_forward)continue;var qa=pa.action_type,ra=pa.thread_id;i.isThreadID(ra);var sa=this.getThreadMetaNow(ra);if(qa==h.LOG_MESSAGE&&pa.log_message_type==m.SERVER_ERROR)continue;var ta=!!(pa.sync_id||pa.action_id);if(!sa&&!ta&&qa==h.USER_GENERATED_MESSAGE){sa=fa(this,pa);this._threads.setResource(ra,sa);}if(sa){if(qa==h.DELETE_THREAD){sa.message_count=0;this._threadInformer.deletedThread(ra);continue;}if(qa==h.LOG_MESSAGE||qa==h.USER_GENERATED_MESSAGE)ta=!ka;if(sa.server_timestamp&&pa.timestamp<=sa.server_timestamp&&ta)continue;if(!na[ra])na[ra]=u({},sa);ea(this,na[ra],pa,ka);if(qa==h.USER_GENERATED_MESSAGE)la[ra]=pa;if(qa==h.USER_GENERATED_MESSAGE||qa==h.LOG_MESSAGE||qa==h.SEND_MESSAGE)if(pa&&pa.timestamp&&(!ma[ra]||pa.timestamp>ma[ra].timestamp))ma[ra]=pa;}}for(var ua in na){var va=na[ua],wa=la[ua];if(wa)aa(va,wa);var xa=ma[ua],ya=va.timestamp;if(xa){if(xa.timestamp>ya)va=u(va,{timestamp_absolute:xa.timestamp_absolute,timestamp_relative:xa.timestamp_relative,timestamp:xa.timestamp});var za=va.server_timestamp;if(!ka&&xa.timestamp>za)va.server_timestamp=xa.timestamp;}this._threads.setResource(ua,va);}},_getCanonicalThreadToUser:function(ja,ka,la,ma){return this.getCanonicalThreadToParticipant('fbid:'+ja,ka,la,ma);},getCanonicalThreadToParticipant:function(ja,ka,la,ma){var na=l.getThreadIDFromParticipantID(ja),oa=this._threads.getResource(na);if(typeof oa=='undefined'){oa=this.createNewLocalThread(na,[l.getParticipantIDFromUserID(this._fbid),ja],ka);!ma&&this._serverRequests.fetchThreadData([na],la);}return oa;},createNewLocalThread:function(ja,ka,la){var ma=this._threads.getResource(ja);if(!ma){var na=l.tokenize(ja);ma={thread_id:ja,last_action_id:null,participants:ka,name:null,snippet:'',snippet_has_attachment:false,snippet_sender:null,unread_count:la?la:0,message_count:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,canonical_fbid:na.type==='user'?na.value:null,is_canonical_user:na.type=='user',is_canonical:ha(this,ka),is_subscribed:true,root_message_threading_id:null,folder:q.INBOX,is_archived:false,mode:p.TITAN_ORIGINATED};this._threads.setResource(ja,ma);}return ma;},addParticipantsToThreadLocally:function(ja,ka){var la=this._threads.getResource(ja);if(la){x(this,la,ka);this._threadInformer.updatedThread(la.thread_id);}},isEmptyLocalThread:function(ja){var ka=this._threads.getResource(ja);if(!ka)return false;var la=l.tokenize(ja);return la.type=='root'&&!ka.timestamp;},isNewEmptyLocalThread:function(ja){if(!this.isEmptyLocalThread(ja))return false;var ka=this._threads.getResource(ja);return ka.participants&&ka.participants.length===0;},canReply:function(ja){var ka=this._threads.getResource(ja);return ka&&ka.is_subscribed&&ka.mode!=p.OBJECT_ORIGINATED&&!ka.has_email_participant&&!ka.read_only&&(ka.recipients_loadable||ka.recipients_loadable===undefined);}});u(ga,o);function ha(ja,ka){var la=ka.filter(function(ma){return ma!=l.getParticipantIDFromUserID(ja._fbid);});return la.length<=1;}function ia(ja){ja._serverRequests.subscribe('update-threads',function(ka,la){var ma=(la.actions||[]).filter(function(qa){return qa.thread_id;});if(la.payload_source==n.SERVER_FETCH_THREAD_INFO)(la.threads||[]).forEach(function(qa){var ra=qa.thread_id;if(ja._pendingReadStatusThreads[ra]){delete ja._pendingReadStatusThreads[ra];if(qa.unread_count)ja._serverRequests.changeThreadReadStatus(qa.thread_id,true);}});ja.updateThreads(la.threads);ja.updateMetadataByActions(ma,la.from_client);(la.threads||[]).forEach(function(qa){ja._threadInformer.updatedThread(qa.thread_id);});var na=la.global_actions||[];for(var oa=0;oa<na.length;oa++){var pa=na[oa];if(pa.action_type==k.MARK_ALL_READ)ba(ja,pa.folder);}});}r.registerCallback('mercury-threads',function(){var ja={};ja.threads={};var ka=ga._getInstances();for(var la in ka)ja.threads[la]=ka[la]._threads.dumpResources();return ja;});e.exports=ga;},null);
__d("MercuryFolders",["MessagingTag","arrayContains"],function(a,b,c,d,e,f,g,h){var i=[g.INBOX,g.OTHER,g.ACTION_ARCHIVED,g.SPAM],j={getSupportedFolders:function(){return i.concat();},isSupportedFolder:function(k){return h(i,k);},getFromMeta:function(k){var l=k.folder;if(k.is_archived)l=g.ACTION_ARCHIVED;return l;}};e.exports=j;},null);
__d("MercuryUnreadState",["MercuryFolders","LogHistory","KeyedCallbackManager","MercuryActionTypeConstants","MercuryGlobalActionType","MercurySingletonMixin","MercuryThreadlistConstants","MessagingTag","ReportState","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","arrayContains","copyProperties","createObjectFrom"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u){var v=(g.getSupportedFolders()||[]).filter(function(na){return na!=n.ACTION_ARCHIVED;}),w='unread_thread_hash',x='unseen_thread_list',y=m.MAX_UNREAD_COUNT,z=h.getInstance('mercury_unread_state');function aa(na){this._fbid=na;this._serverRequests=p.getForFBID(this._fbid);this._threadInformer=q.getForFBID(this._fbid);this._threads=r.getForFBID(this._fbid);this._allReadTimestamp={};this._threadReadTimestamp={};this._initialUnreadCount={};this._maxCount={};this._unreadResources={};v.forEach(function(oa){this._initialUnreadCount[oa]=0;this._maxCount[oa]=false;this._unreadResources[oa]=new i();}.bind(this));this._serverRequests.subscribe('update-unread',function(oa,pa){fa(this,pa);var qa=pa.global_actions||[];for(var ra=0;ra<qa.length;ra++){var sa=qa[ra];if(sa.action_type==k.MARK_ALL_READ)ia(this,sa.folder,sa.timestamp);}}.bind(this));this._serverRequests.subscribe('update-thread-ids',function(oa,pa){ka(this,pa);}.bind(this));}t(aa.prototype,{getUnreadCount:function(na){if(this.exceedsMaxCount(na)){z.error('unguarded_unread_count_fetch',{});return 0;}return ea(this,na);},exceedsMaxCount:function(na){return this._maxCount[na]||(ea(this,na)>y);},markFolderAsRead:function(na){if(this._maxCount[na]||ea(this,na)>0)this._serverRequests.markFolderAsRead(na);}});t(aa,l);function ba(na,oa,pa){na._unreadResources[oa].setResource(w,pa);na._unreadResources[oa].setResource(x,Object.keys(pa));}function ca(na,oa,pa){var qa=na._unreadResources[oa].executeOrEnqueue(w,pa),ra=na._unreadResources[oa].getUnavailableResources(qa);if(ra.length)na._serverRequests.fetchUnreadThreadIDs(oa);}function da(na,oa){return na._unreadResources[oa].getResource(w);}function ea(na,oa){var pa=na._unreadResources[oa].getResource(x);if(pa){return pa.length;}else return na._initialUnreadCount[oa];}function fa(na,oa){var pa;(oa.unread_thread_fbids||[]).forEach(function(qa){pa=qa.folder;if(!ma(pa))return;var ra=qa.thread_fbids||[];ra=ra.concat(qa.other_user_fbids||[]);var sa=ja(na,ra);ba(na,pa,u(sa,true));if(sa.length>y)na._maxCount[pa]=true;na._threadInformer.updatedUnreadState();});(oa.message_counts||[]).forEach(function(qa){if(qa.unread_count===undefined)return;pa=qa.folder;if(qa.unread_count>y){na._maxCount[pa]=true;ba(na,pa,{});na._threadInformer.updatedUnreadState();}else{na._initialUnreadCount[pa]=qa.unread_count;if(na._initialUnreadCount[pa]===0)ba(na,pa,{});na._threadInformer.updatedUnreadState();}});(oa.actions||[]).forEach(function(qa){if(qa.is_forward)return;var ra=j,sa=qa.other_user_fbid?qa.other_user_fbid:qa.thread_fbid,ta=qa.thread_id?qa.thread_id:sa;if(qa.action_type==ra.DELETE_THREAD){v.forEach(function(va){ha(na,va,ta);});}else if(qa.action_type==ra.CHANGE_ARCHIVED_STATUS||qa.action_type==ra.CHANGE_FOLDER){var ua=na._threads.getThreadMetaNow(qa.thread_id);pa=g.getFromMeta(ua);if(ma(pa)&&ua.unread_count>0)ga(na,pa,ta);v.forEach(function(va){if(va!=pa)ha(na,va,ta);});}else{pa=la(na,qa);if(!ma(pa))return;if(qa.action_type==ra.CHANGE_READ_STATUS){if(qa.mark_as_read){ha(na,pa,ta,qa.timestamp);}else ga(na,pa,ta,qa.timestamp);}else if(qa.action_type==ra.USER_GENERATED_MESSAGE||qa.action_type==ra.LOG_MESSAGE)if(qa.is_unread)ga(na,pa,ta,qa.timestamp);}});}function ga(na,oa,pa,qa){if(na._maxCount[oa])return;ca(na,oa,function(ra){var sa=na._allReadTimestamp[oa]||0,ta=na._threadReadTimestamp[pa]||0,ua=qa||Number.POSITIVE_INFINITY;if(ua>=sa&&ua>=ta&&!ra[pa]){ra[pa]=qa||0;ba(na,oa,ra);na._threadInformer.updatedUnreadState();}});}function ha(na,oa,pa,qa){if(na._maxCount[oa])return;ca(na,oa,function(ra){if(qa){var sa=na._threadReadTimestamp[pa];if(!sa||sa<qa)na._threadReadTimestamp[pa]=qa;}var ta=ra[pa];if(qa&&typeof ta=='number'&&qa<ta)return;if(pa in ra){delete ra[pa];ba(na,oa,ra);na._threadInformer.updatedUnreadState();}});}function ia(na,oa,pa){na._maxCount[oa]=false;ba(na,oa,{});na._allReadTimestamp[oa]=Math.max(na._allReadTimestamp[oa]||0,pa||0);na._threadInformer.updatedUnreadState();}function ja(na,oa){return oa.map(na._serverRequests.convertThreadIDIfAvailable,na._serverRequests);}function ka(na,oa){v.forEach(function(pa){var qa=da(na,pa);if(!qa)return;for(var ra in oa){var sa=oa[ra];if(qa[ra]){qa[sa]=qa[ra];delete qa[ra];}}ba(na,pa,qa);});}function la(na,oa){var pa=oa.thread_id?na._threads.getThreadMetaNow(oa.thread_id):null;return pa?g.getFromMeta(pa):oa.folder;}function ma(na){return s(v,na);}o.registerCallback('mercury-unread-state',function(){var na={};na.unread={};na.unread_max_count={};var oa=aa._getInstances();for(var pa in oa){na.unread[pa]={};na.unread_max_count[pa]={};v.forEach(function(qa){na.unread[pa][qa]=t({},da(oa[pa],qa));na.unread_max_count[pa][qa]=oa[pa]._maxCount[qa];});}return na;});e.exports=aa;},null);